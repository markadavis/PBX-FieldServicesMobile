/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../NodeHierarchy","../NodeContentType","sap/ui/base/ObjectPool","./BaseNodeProxy","./NodeProxy","./LayerProxy","../Messages","../DvlException","./checkResult","./getJSONObject","../getResourceBundle"],function(q,N,a,O,B,b,L,M,D,c,g,d){"use strict";var l=q.sap.log;var s={modeDictionary:{equals:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_EQUAL_CASE_INSENSITIVE;},contains:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_SUBSTRING_CASE_INSENSITIVE;},startsWith:function(i){return i?sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH:sap.ve.dvl.DVLFINDNODEMODE.DVLFINDNODEMODE_STARTS_WITH_CASE_INSENSITIVE;}}};var f=N.extend("sap.ui.vk.dvl.NodeHierarchy",{metadata:{},_baseNodeProxyPool:new O(B),constructor:function(e){N.call(this);this._graphicsCore=e.getGraphicsCore();this._scene=e;this._dvlSceneRef=this._scene.getSceneRef();this._dvl=this._graphicsCore._getDvl();this._nodeProxies=[];this._layerProxies=[];}});f.prototype.destroy=function(){this._layerProxies.slice().forEach(this.destroyLayerProxy,this);this._nodeProxies.slice().forEach(this.destroyNodeProxy,this);this._dvl=null;this._dvlSceneRef=null;this._scene=null;this._graphicsCore=null;N.prototype.destroy.call(this);};f.prototype.getGraphicsCore=function(){return this._graphicsCore;};f.prototype.getScene=function(){return this._scene;};f.prototype.getSceneRef=function(){return this._dvlSceneRef;};f.prototype.enumerateChildren=function(n,e,h,p){if(typeof n==="function"){p=h;h=e;e=n;n=undefined;}var i;if(n){if(h||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){i=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{i=[];}}else{i=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}if(p){i.forEach(e);}else{var j=this._baseNodeProxyPool.borrowObject();try{i.forEach(function(n){j.init(this,n);e(j);j.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(j);}}return this;};f.prototype.enumerateAncestors=function(n,e,p){var h=g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;if(p){h.forEach(e);}else{var i=this._baseNodeProxyPool.borrowObject();try{h.forEach(function(n){i.init(this,n);e(i);i.reset();}.bind(this));}finally{this._baseNodeProxyPool.returnObject(i);}}return this;};f.prototype.createNodeProxy=function(n){var e=new b(this,n);this._nodeProxies.push(e);return e;};f.prototype.destroyNodeProxy=function(n){var i=this._nodeProxies.indexOf(n);if(i>=0){this._nodeProxies.splice(i,1)[0].destroy();}return this;};f.prototype.getChildren=function(n,e){if(typeof n==="boolean"){e=n;n=undefined;}if(n){if(e||(g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_FLAGS)).Flags&sap.ve.dvl.DVLNODEFLAG.DVLNODEFLAG_CLOSED)===0){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_CHILDREN)).ChildNodes;}else{return[];}}else{return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_CHILDREN)).ChildNodes;}};f.prototype.getAncestors=function(n){return g(this._dvl.Scene.RetrieveNodeInfo(this._dvlSceneRef,n,sap.ve.dvl.DVLNODEINFO.DVLNODEINFO_PARENTS)).ParentNodes;};f.prototype.findNodesByName=function(e){var h=sap.ve.dvl.DVLFINDNODETYPE.DVLFINDNODETYPE_NODE_NAME,j=[],k,m;if(e===undefined||e===null||q.isEmptyObject(e)){k=s.modeDictionary.contains(false);m=[""];}else{if(e.value===undefined||e.value===null||e.value===""){q.sap.log.error(d().getText(M.VIT6.summary),M.VIT6.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}var p=e.hasOwnProperty("predicate")?e.predicate:"equals";if(p===undefined||p===null||p===""){q.sap.log.error(d().getText(M.VIT7.summary),M.VIT7.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}else if(["equals","contains","startsWith"].indexOf(p)===-1){q.sap.log.error(d().getText(M.VIT8.summary),M.VIT8.code,"sap.ui.vk.dvl.NodeHierarchy");return[];}k=s.modeDictionary[p](e.caseSensitive);m=(typeof e.value==="string")?[e.value]:e.value;}for(var i=0;i<m.length;i++){j=j.concat(g(this._dvl.Scene.FindNodes(this._dvlSceneRef,h,k,m[i])).nodes);}return q.sap.unique(j);};f.prototype.createLayerProxy=function(e){var h=new L(this,e);this._layerProxies.push(h);return h;};f.prototype.destroyLayerProxy=function(e){var i=this._layerProxies.indexOf(e);if(i>=0){this._layerProxies.splice(i,1)[0].destroy();}return this;};f.prototype.getLayers=function(){return g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_LAYERS)).Layers;};f.prototype.getHotspotNodeIds=function(){var h=g(this._dvl.Scene.RetrieveSceneInfo(this._dvlSceneRef,sap.ve.dvl.DVLSCENEINFO.DVLSCENEINFO_HOTSPOTS).ChildNodes);return h.length>0?h:this._getLegacyHotspotNodeIds();};f.prototype._getLegacyHotspotNodeIds=function(){var e=this.getLayers(),h=[];for(var i=0;i<e.length;i++){var j=this.createLayerProxy(e[i]),k=j.getName();if(k.toLowerCase()==="hotspots"){h=j.getNodes();this.destroyLayerProxy(j);break;}this.destroyLayerProxy(j);}return h;};f.prototype.createNode=function(p,n,i){var e=this._dvl.Scene.CreateNode(this._dvlSceneRef,p,n,i);this.fireNodeCreated({nodeRef:e,nodeId:e});this.fireChanged();return e;};f.prototype.createNodeCopy=function(n,p,e,i){var h=this._dvl.Scene.CreateNodeCopy(this._dvlSceneRef,n,p,sap.ve.dvl.DVLCREATENODECOPYFLAG.COPY_CHILDREN,e,i);this.fireNodeCreated({nodeRef:h,nodeId:h});this.fireChanged();return h;};f.prototype.getNodeContentType=function(n){return a.Regular;};f.prototype.removeNode=function(n){var h=[].concat(n);h.forEach(function(n){this.fireNodeRemoving({nodeRef:n,nodeId:n});try{c(this._dvl.Scene.DeleteNode(this._dvlSceneRef,n));}catch(e){var m="Failed to delete node with ID = "+n+".";if(e instanceof D){m+=" Error code: "+e.code+". Message: "+e.message+".";}l.error(m);}}.bind(this));this.fireChanged();return this;};return f;});
