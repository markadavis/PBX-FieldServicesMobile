/*!
* SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
*/
sap.ui.define(["../Core","../ViewStateManagerBase","../cssColorToColor","../colorToCSSColor","../abgrToColor","../colorToABGR","./Scene"],function(v,V,c,a,b,d,S){"use strict";var e;var f=V.extend("sap.ui.vk.svg.ViewStateManager",{metadata:{}});var g=f.getMetadata().getParent().getClass().prototype;f.prototype.init=function(){if(g.init){g.init.call(this);}this._mask=(1|0);this._nodeHierarchy=null;this._selectedNodes=new Set();this._visibilityTracker=new e();this.setHighlightColor(0xC00000FF);};f.prototype._setContent=function(h){var s=null;if(h&&h instanceof S){s=h;}this._setScene(s);if(s){var i=s.getInitialView();if(i){this._currentView=i;this._resetNodesMaterialAndOpacityByCurrenView(this._currentView);}}return this;};f.prototype._setScene=function(s){this._setNodeHierarchy(s?s.getDefaultNodeHierarchy():null);if(s){s.setViewStateManager(this);}this._scene=s;return this;};f.prototype._setNodeHierarchy=function(n){var o=this._nodeHierarchy;if(this._nodeHierarchy){this._nodeHierarchy=null;this._selectedNodes.clear();this._visibilityTracker.clear();}if(n){this._nodeHierarchy=n;this._nodeHierarchy.attachNodeReplaced(this._handleNodeReplaced,this);this._nodeHierarchy.attachNodeUpdated(this._handleNodeUpdated,this);this._nodeHierarchy.attachNodeRemoving(this._handleNodeRemoving,this);this._initialState={visible:[],hidden:[]};var h=this;var i=n.findNodesByName();i.forEach(function(j){(j.isVisible(h._mask)?h._initialState.visible:h._initialState.hidden).push(j);});this.fireVisibilityChanged({visible:this._initialState.visible,hidden:this._initialState.hidden});}if(n!==o){this.fireNodeHierarchyReplaced({oldNodeHierarchy:o,newNodeHierarchy:n});}return this;};f.prototype._handleNodeReplaced=function(h){var r=h.getParameter("ReplacedNodeRef");var i=h.getParameter("ReplacementNodeRef");if(this.getSelectionState(r)){this.setSelectionState(i,true);this.setSelectionState(r,false);}};f.prototype._handleNodeUpdated=function(h){var n=h.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false);this.setSelectionState(n,true);}};f.prototype._handleNodeRemoving=function(h){var n=h.getParameter("nodeRef");if(this.getSelectionState(n)){this.setSelectionState(n,false,true,true);}};f.prototype.getNodeHierarchy=function(){return this._nodeHierarchy;};f.prototype.getVisibilityChanges=function(){return this.getShouldTrackVisibilityChanges()?this._visibilityTracker.getInfo(this.getNodeHierarchy()):null;};f.prototype.getCurrentView=function(){var h=sap.ui.getCore().byId(this.getViewManager());if(!h){return null;}var i=h.getActiveView();return i;};f.prototype.getVisibilityComplete=function(){var n=this.getNodeHierarchy(),h=n.findNodesByName(),i=[],j=[];h.forEach(function(k){var l=n.createNodeProxy(k);var m=l.getVeId();n.destroyNodeProxy(l);if(m){if(this.getVisibilityState(k)){i.push(m);}else{j.push(m);}}},this);return{visible:i,hidden:j};};f.prototype.resetVisibility=function(){this.setVisibilityState(this._initialState.visible,true,false);this.setVisibilityState(this._initialState.hidden,false,false);this._visibilityTracker.clear();};f.prototype.getVisibilityState=function(n){var m=this._mask;if(Array.isArray(n)){return n.map(function(h){return h?h.isVisible(m):false;});}return n?n.isVisible(m):false;};f.prototype.setVisibilityState=function(n,h,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(h);var j=[];var k=n;if(r){k=[];n.forEach(function(q,s){var w=this._collectNodesRecursively(q);k=k.concat(w);var x=j.length;j.length=x+w.length;j.fill(i?h[s]:h,x);},this);}else if(!i){j.length=k.length;j.fill(h);}else{j=h;}var l=[];var u=new Set();var m=this._mask;var o=k.filter(function(q,s){if(u.has(q)){return false;}u.add(q);var o=q?q.isVisible(m)!=j[s]:false;if(o){l.push(j[s]);}return o;},this);if(o.length>0){var p={visible:[],hidden:[]};o.forEach(function(q,s){if(l[s]){q.setVisible(m,true);p.visible.push(q);}else{q.setVisible(m,false);p.hidden.push(q);}},this);if(this.getShouldTrackVisibilityChanges()){o.forEach(this._visibilityTracker.trackNodeRef,this._visibilityTracker);}this.fireVisibilityChanged(p);}return this;};f.prototype.enumerateSelection=function(h){this._selectedNodes.forEach(h);return this;};f.prototype.getSelectionState=function(n){var s=this._selectedNodes;function i(h){return s.has(h);}return Array.isArray(n)?n.map(i):i(n);};f.prototype._getSelectionComplete=function(){var n=this.getNodeHierarchy(),s=[];function h(i){var j=n.createNodeProxy(i);var k=j.getVeId();n.destroyNodeProxy(j);return k;}this._selectedNodes.forEach(function(i){var j=h(i);if(j){s.push(j);}});return{selected:s};};f.prototype._isAncestorSelected=function(n){n=n.parent;while(n){if(this._selectedNodes.has(n)){return true;}n=n.parent;}return false;};f.prototype._updateHighlightColor=function(n,p){var s=p||this._selectedNodes.has(n);n.setSelected(this._mask,s,this._highlightColorABGR);var h=n.children;for(var i=0,l=h.length;i<l;i++){this._updateHighlightColor(h[i],s);}};f.prototype.setSelectionState=function(n,s,r,h){if(!Array.isArray(n)){n=[n];}n=(r||this.getRecursiveSelection()?this._collectNodesRecursively(n):n).filter(function(j,k,l){return l.indexOf(j)===k;});if(this.getRecursiveSelection()&&!s){n=this._nodeHierarchy._appendAncestors(n);}var i=n.filter(function(j){return this._selectedNodes.has(j)!==s;},this);if(i.length>0){i.forEach(function(j){if(j){this._selectedNodes[s?"add":"delete"](j);}},this);i.forEach(function(j){if(j){this._updateHighlightColor(j,s||this._isAncestorSelected(j));}},this);if(!h){this.fireSelectionChanged({selected:s?i:[],unselected:s?[]:i});}}return this;};f.prototype.setSelectionStates=function(s,u,r,h){if(!Array.isArray(s)){s=[s];}if(!Array.isArray(u)){u=[u];}s=(r||this.getRecursiveSelection()?this._collectNodesRecursively(s):s);u=(r||this.getRecursiveSelection()?this._collectNodesRecursively(u):u);if(this.getRecursiveSelection()){u=this._nodeHierarchy._appendAncestors(u,s);}var i=s.filter(function(n){return this._selectedNodes.has(n)===false;},this);var j=u.filter(function(n){return this._selectedNodes.has(n)===true;},this);if(i.length>0||j.length>0){i.forEach(function(n){this._selectedNodes.add(n);this._updateHighlightColor(n,true);},this);j.forEach(function(n){this._selectedNodes.delete(n);},this);j.forEach(function(n){this._updateHighlightColor(n,this._isAncestorSelected(n));},this);if(!h){this.fireSelectionChanged({selected:i,unselected:j});}}return this;};f.prototype._collectNodesRecursively=function(n){var r=[],h=this;if(!Array.isArray(n)){n=[n];}n.forEach(function j(i){r.push(i);h._nodeHierarchy.enumerateChildren(i,j,false,true);});return r;};f.prototype._getOpacity=function(n){return n.opacity!==undefined?n.opacity:null;};f.prototype.getOpacity=function(n){if(Array.isArray(n)){return n.map(this._getOpacity,this);}else{return this._getOpacity(n);}};f.prototype.setOpacity=function(n,o,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(o);if(o===null){o=undefined;}else if(i){o.forEach(function(p,q){if(p===null){o[q]=undefined;}});}var h=[];var j=n;if(!i){h.length=j.length;h.fill(o);}else{h=o;}var k=[];var u=new Set();var l=j.filter(function(p,q){if(u.has(p)){return false;}u.add(p);var l=p?p.opacity!==h[q]:false;if(l){k.push(h[q]);}return l;},this);if(l.length>0){var m=this._mask;l.forEach(function(p,q){p.setOpacity(m,k[q]);},this);this.fireOpacityChanged({changed:l,opacity:i?k:k[0]});}return this;};f.prototype._getTintColorABGR=function(n){return n.tintColor!==undefined?n.tintColor:null;};f.prototype._getTintColor=function(n){return n.tintColor!==undefined?a(b(n.tintColor)):null;};f.prototype.getTintColor=function(n,i){var h=i?"_getTintColorABGR":"_getTintColor";if(Array.isArray(n)){return n.map(this[h],this);}else{return this[h](n);}};function t(h){switch(typeof h){case"number":return h>>>0;case"string":return sap.ui.core.CSSColor.isValid(h)?d(c(h)):undefined;default:return undefined;}}f.prototype.setTintColor=function(n,h,r){if(!Array.isArray(n)){n=[n];}var i=Array.isArray(h);var j=[];var k=n;if(r){k=[];n.forEach(function(s,w){var x=this._collectNodesRecursively(s);k=k.concat(x);var y=j.length;j.length=y+x.length;j.fill(i?h[w]:h,y);},this);}else if(!i){j.length=k.length;j.fill(h);}else{j=h;}var l=[];var u=new Set();var m=k.filter(function(s,w){if(u.has(s)){return false;}u.add(s);var m=s?s.tintColor!==t(j[w]):false;if(m){l.push(j[w]);}return m;},this);if(m.length>0){var o=this._mask;var p=[];m.forEach(function(s,w){var x=t(l[w]);s.setTintColor(o,x);p.push(x);},this);var q={changed:m,tintColor:i?l:l[0],tintColorABGR:i?p:p[0]};this.fireTintColorChanged(q);}return this;};f.prototype.setHighlightColor=function(h){h=t(h);if(h===undefined){return this;}this._highlightColorABGR=h;if(this._selectedNodes.size>0){this._selectedNodes.forEach(function(n){this._updateHighlightColor(n,true);},this);}this.fireHighlightColorChanged({highlightColor:a(b(h)),highlightColorABGR:h});return this;};f.prototype.getHighlightColor=function(i){return i?this._highlightColorABGR:a(b(this._highlightColorABGR));};e=function(){this._visibilityChanges=new Set();};e.prototype.getInfo=function(n){var h=[];this._visibilityChanges.forEach(function(i){var j=n.createNodeProxy(i);var k=j.getVeId();n.destroyNodeProxy(j);if(k){h.push(k);}else{h.push(n.getScene().nodeRefToPersistentId(i));}});return h;};e.prototype.clear=function(){this._visibilityChanges.clear();};e.prototype.trackNodeRef=function(n){if(this._visibilityChanges.has(n)){this._visibilityChanges.delete(n);}else{this._visibilityChanges.add(n);}};return f;});
