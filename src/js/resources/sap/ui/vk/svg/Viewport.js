/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./ViewportRenderer","../ViewportBase","sap/ui/core/ResizeHandler","sap/ui/events/KeyCodes","../Loco","../ViewStateManager","./ViewStateManager","../ViewportHandler","../VisibilityMode","../ZoomTo","../SelectionMode","../getResourceBundle","../Messages","./Scene","./OrthographicCamera","./Rectangle"],function(V,c,R,K,L,d,e,g,h,Z,S,i,M,j,O,k){"use strict";var l=c.extend("sap.ui.vk.svg.Viewport",{metadata:{library:"sap.ui.vk",properties:{zoomInLimit:{type:"float",defaultValue:500},zoomOutLimit:{type:"float",defaultValue:0.25}},events:{cameraChanged:{parameters:{offset:"float[]",zoom:"float"},enableEventBubbling:true},hotspotEnter:{parameters:{nodeRef:"any"},enableEventBubbling:true},hotspotLeave:{parameters:{nodeRef:"any"},enableEventBubbling:true}}}});var m=l.getMetadata().getParent().getClass().prototype;l.prototype.init=function(){if(m.init){m.init.call(this);}this._resizeListenerId=null;this._animLoopRequestId=0;this._animLoopFunction=this._animLoop.bind(this);this._width=this._height=0;this._camera=new O();this._gestureX=0;this._gestureY=0;this._scene=null;this._selectionRect=new k({material:{lineColor:[0.75,0.75,0,1],lineStyle:{dashPattern:[2,2]}}});this._viewportHandler=new g(this);this._loco=new L(this);this._loco.addHandler(this._viewportHandler,-1);};l.prototype.exit=function(){this._loco.removeHandler(this._viewportHandler);this._viewportHandler.destroy();if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}this.setScene(null);this._renderer=null;this._loco=null;this._viewportHandler=null;if(m.exit){m.exit.call(this);}};l.prototype.onBeforeRendering=function(){if(this._resizeListenerId){R.deregister(this._resizeListenerId);this._resizeListenerId=null;}};l.prototype.onAfterRendering=function(){this._resizeListenerId=R.register(this,this._handleResize.bind(this));var a=this.getDomRef();if(this._scene){var b=this._scene.getRootElement();b._setDomRef(document.getElementById(b.uid));}this._handleResize({size:{width:a.clientWidth,height:a.clientHeight}});};l.prototype._handleResize=function(a){var b=this._width;var f=this._height;this._width=a.size.width;this._height=a.size.height;if(b===0||f===0){this.zoomTo(Z.All,null,0,0);}else{this._camera.update(this._width,this._height,b,f);this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()});}this.fireResize({size:{width:this._width,height:this._height}});return true;};l.prototype.setScene=function(a){this._scene=a;if(a){this.zoomTo(Z.All,null,0,0);this.invalidate();}return this;};l.prototype.getScene=function(){return this._scene;};l.prototype.onSetViewStateManager=function(v){this._viewStateManager=v;};l.prototype.onRemoveViewStateManager=function(v){this._viewStateManager=null;};l.prototype._getViewStateManagerSVG=function(){if(this._viewStateManager){if(this._viewStateManager instanceof e){return this._viewStateManager;}if(this._viewStateManager instanceof d&&this._viewStateManager._implementation instanceof e){return this._viewStateManager._implementation;}}return null;};l.prototype.hitTest=function(x,y){var v=this._getViewStateManagerSVG();if(!v||!this._scene){return null;}var a=this._scene.getRootElement();var b=this.getDomRef().getBoundingClientRect();var f=document.elementFromPoint(x+b.x,y+b.y);var q=f!==null&&f.id?a.getElementById(f.id):null;return q?q._getSceneTreeElement():null;};l.prototype.tap=function(x,y,a){var b=this.hitTest(x,y);if(!a){this.tapObject(b);if(b!==null){this.fireNodeClicked({nodeRef:b,x:x,y:y},true,true);}}else if(!this.getFreezeCamera()){if(b&&this._camera.zoomedObject!==b){this._camera.zoomedObject=b;this.zoomTo(Z.Node,this._camera.zoomedObject,0.5,0.1);}else{this._camera.zoomedObject=null;this.zoomTo(Z.Visible,null,0.5,0);}}return this;};l.prototype.tapObject=function(a){var b={picked:a?[a]:[]};this.fireNodesPicked(b);if(this.getSelectionMode()===S.Exclusive){this.exclusiveSelectionHandler(b.picked);}else if(this.getSelectionMode()===S.Sticky){this.stickySelectionHandler(b.picked);}return this;};var o={x:-2,y:-2};var r=2;var p=5;l.prototype.onkeydown=function(a){if(!a.isMarked()){switch(a.keyCode){case K.ARROW_LEFT:case K.ARROW_RIGHT:case K.ARROW_UP:case K.ARROW_DOWN:if(a.ctrlKey||a.altKey||a.metaKey){break;}var b={x:0,y:0};switch(a.keyCode){case K.ARROW_LEFT:b.x=-1;break;case K.ARROW_RIGHT:b.x=+1;break;case K.ARROW_UP:b.y=-1;break;case K.ARROW_DOWN:b.y=+1;break;default:break;}this.beginGesture(o.x,o.y);if(a.shiftKey){this.pan(p*b.x,p*b.y);}else{this.rotate(r*b.x,r*b.y,true);}this.endGesture();a.preventDefault();a.stopPropagation();break;case 189:case K.PLUS:case K.NUMPAD_MINUS:case K.NUMPAD_PLUS:this.beginGesture(this._width*0.5,this._height*0.5);this.zoom(a.keyCode===K.PLUS||a.keyCode===K.NUMPAD_PLUS?1.02:0.98);this.endGesture();a.preventDefault();a.stopPropagation();break;default:break;}}};l.prototype.setSelectionRect=function(a){var b=document.getElementById(this._selectionRect.uid);if(b){b.setAttribute("visibility",a?"visible":"hidden");if(a){a=this._camera._transformRect(a);b.setAttribute("x",a.x1,a.x2);b.setAttribute("y",a.y1,a.y2);b.setAttribute("width",a.x2-a.x1);b.setAttribute("height",a.y2-a.y1);}}};l.prototype._select=function(a){var v=this._getViewStateManagerSVG();if(v&&this._scene){a=this._camera._transformRect(a);var b=new Set();this._scene.getRootElement()._findRectElementsRecursive(b,a,v._mask);v.setSelectionStates(Array.from(b),[]);}};l.prototype.getImage=function(w,a,t,b,f){return null;};l.prototype._setContent=function(a){this.setScene(a instanceof j?a:null);var b=new O();b.reset(a&&a.camera,this._width,this._height);this.setCamera(b);return this;};l.prototype.onSetContentConnector=function(a){c.prototype.onSetContentConnector.call(this,a);a.attachContentLoadingFinished(this._onContentLoadingFinished,this);};l.prototype.onUnsetContentConnector=function(a){a.detachContentLoadingFinished(this._onContentLoadingFinished,this);c.prototype.onUnsetContentConnector.call(this,a);};l.prototype._onContentLoadingFinished=function(a){if(this._scene){this.zoomTo(Z.All,null,0,0);this.invalidate();}};function n(a,b,f){return a+(b-a)*f;}function s(a,b,x){x=Math.min(Math.max((x-a)/(b-a),0.0),1.0);return x*x*x*(x*(x*6-15)+10);}l.prototype._animLoop=function(){this._animLoopRequestId=0;var a=this._anim;if(a){var b=a.start;var q=a.end;var t=Date.now();var f=Math.min(s(0,1,(t-b.time)/a.duration),1);this._camera.offsetX=n(b.offsetX,q.offsetX,f);this._camera.offsetY=n(b.offsetY,q.offsetY,f);this._camera.zoom=n(b.zoom,q.zoom,f);this.fireCameraChanged({viewBox:this._getViewBox()});if(this._updateViewBox()&&(t-b.time)<a.duration){this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction);}else{delete this._anim;}}};l.prototype.zoomTo=function(w,a,b,f){if(this._width===0||this._height===0||this._scene==null){return this;}var q={min:{x:Infinity,y:Infinity},max:{x:-Infinity,y:-Infinity}};var v=this._getViewStateManagerSVG();(Array.isArray(w)?w:[w]).forEach(function(w){switch(w){case Z.All:this._scene.getRootElement()._expandBoundingBoxRecursive(q,-1>>>0);break;case Z.Visible:if(v){this._scene.getRootElement()._expandBoundingBoxRecursive(q,v._mask);}break;case Z.Selected:if(v){v.enumerateSelection(function(a){a._expandBoundingBoxRecursive(q,-1>>>0);});}break;case Z.Node:if(!a){return this;}if(Array.isArray(a)){a.forEach(function(a){a._expandBoundingBoxRecursive(q,-1>>>0);});}else{a._expandBoundingBoxRecursive(q,-1>>>0);}break;case Z.Restore:jQuery.sap.log.error(i().getText("VIEWPORT_MSG_RESTORENOTIMPLEMENTED"));return this;case Z.NodeSetIsolation:jQuery.sap.log.error(i().getText("VIEWPORT_MSG_NODESETISOLATIONNOTIMPLEMENTED"));return this;case Z.RestoreRemoveIsolation:jQuery.sap.log.error(i().getText("VIEWPORT_MSG_RESTOREREMOVEISOLATIONNOTIMPLEMENTED"));return this;case Z.ViewLeft:case Z.ViewRight:case Z.ViewTop:case Z.ViewBottom:case Z.ViewBack:case Z.ViewFront:return this;default:break;}}.bind(this));if(q.min.x<q.max.x&&q.min.y<q.max.y){var t=new O();t._zoomTo(q,this._width,this._height,f);this._activateCamera(t,b);}return this;};l.prototype._activateCamera=function(a,f){if(f>0&&!this._animLoopRequestId){this._anim={start:{time:Date.now(),offsetX:this._camera.offsetX,offsetY:this._camera.offsetY,zoom:this._camera.zoom},end:{offsetX:a.offsetX,offsetY:a.offsetY,zoom:a.zoom},duration:f*1e3};this._animLoopRequestId=window.requestAnimationFrame(this._animLoopFunction);}else{this._camera.zoom=a.zoom;this._camera.offsetX=a.offsetX;this._camera.offsetY=a.offsetY;this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()});}};l.prototype.beginGesture=function(x,y){this._gestureX=(x-this._camera.offsetX)/this._camera.zoom;this._gestureY=(y-this._camera.offsetY)/this._camera.zoom;};l.prototype.endGesture=function(){this._gestureX=0;this._gestureY=0;};l.prototype.pan=function(a,b){if(!this.getFreezeCamera()){this._camera.offsetX+=a;this._camera.offsetY+=b;this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()});}};l.prototype.rotate=function(a,b){this.pan(a,b);};l.prototype.zoom=function(z){if(!this.getFreezeCamera()){var a=this._camera.zoom;this._camera.zoom*=z;this._camera.offsetX+=this._gestureX*(a-this._camera.zoom);this._camera.offsetY+=this._gestureY*(a-this._camera.zoom);this._updateViewBox();this.fireCameraChanged({viewBox:this._getViewBox()});}};l.prototype.hover=function(x,y){var a=this.hitTest(x,y);if(this._hotspotElement&&this._hotspotElement!==a){this.fireHotspotLeave({nodeRef:this._hotspotElement});this._hotspotElement.domRef.removeAttribute("filter");this._hotspotElement=null;}if(a&&a.isHotspot){a.domRef.setAttribute("filter","url(#halo)");this._hotspotElement=a;this.fireHotspotEnter({nodeRef:this._hotspotElement});}};l.prototype._getViewBox=function(){var a=this._camera.zoom>0?1/this._camera.zoom:1;return[-this._camera.offsetX*a,-this._camera.offsetY*a,this._width*a,this._height*a];};l.prototype._updateViewBox=function(){var a=this._scene?this._scene.getRootElement():null;var b=a?a.domRef:null;if(b){b.parentNode.setAttribute("viewBox",this._getViewBox().join(" "));return true;}return false;};l.prototype.getViewInfo=function(q){var v={};if(q==null){q={};}if(q.camera==null){q.camera=true;}if(q.camera){v.camera={viewBox:this._getViewBox()};}if(q.visibility&&this._viewStateManager){var a=q.visibility.mode==null?h.Complete:q.visibility.mode;v.visibility={mode:a};if(a===h.Complete){var b=this._viewStateManager.getVisibilityComplete();v.visibility.visible=b.visible;v.visibility.hidden=b.hidden;}else if(this._viewStateManager.getShouldTrackVisibilityChanges()){v.visibility.changes=this._viewStateManager.getVisibilityChanges();}else{jQuery.sap.log.warning(i().getText(M.VIT32.summary),M.VIT32.code,"sap.ui.vk.threejs.Viewport");}}var f=this._getViewStateManagerSVG();if(q.selection&&f){v.selection=f._getSelectionComplete();}return v;};l.prototype.setViewInfo=function(v,f){var a=v.camera;if(a&&a.viewBox){var b=new O();b._setViewBox(a.viewBox,this._width,this._height);this._activateCamera(b,f);}var q=new Map();if(v.visibility||v.selection){var t=this._viewStateManager.getNodeHierarchy(),u=t.findNodesByName();u.forEach(function(D){var E=t.createNodeProxy(D);var F=E.getVeId();t.destroyNodeProxy(E);if(F){q.set(F,D);}});}if(v.visibility){switch(v.visibility.mode){case h.Complete:var w=v.visibility.visible,x=v.visibility.hidden;w.forEach(function(D){this._viewStateManager.setVisibilityState(q.get(D),true,false);},this);x.forEach(function(D){this._viewStateManager.setVisibilityState(q.get(D),false,false);},this);break;case h.Differences:this._viewStateManager.resetVisibility();v.visibility.changes.forEach(function(D){var E=q.get(D);if(E){this._viewStateManager.setVisibilityState(E,!this._viewStateManager.getVisibilityState(E),false);}},this);break;default:jQuery.sap.log.error(i().getText(M.VIT28.summary),M.VIT28.code,"sap.ui.vk.threejs.Viewport");break;}}var y=this._getViewStateManagerSVG();var z=v.selection;if(z&&y){var A=y._getSelectionComplete();if(Array.isArray(z.selected)){var B=[];var C=[];z.selected.forEach(function(D){var E=q.get(D);if(E){B.push(E);}});A.selected.forEach(function(D){var E=q.get(D);if(E&&z.selected.indexOf(D)<0){C.push(E);}});y.setSelectionStates(B,C,false,false);}}return this;};l.prototype.queueCommand=function(a){if(this instanceof l){a();}return this;};l.prototype.getOutputSize=function(){var b=this.getDomRef().getBoundingClientRect();var v=b.width;var a=b.height;var f;f=Math.min(v,a);return{left:(v-f)*0.5,top:(a-f)*0.5,sideLength:f};};l.prototype.setShouldRenderFrame=function(){};l.prototype._isPanoramicActivated=function(){return false;};return l;});
