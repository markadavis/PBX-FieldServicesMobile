/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","./Element","./Ellipse","./Rectangle","./Line","./Polyline","./Path","./Text","../View","../getResourceBundle","../totara/TotaraUtils"],function(L,E,a,R,b,P,c,T,V,g,d){"use strict";var S=function(r,i,j,k){this._rootNode=r;this._contentResource=i;this._resolve=j;this._reject=k;this._cameras=new Map();this._sceneIdTreeNodesMap=new Map();this._sceneIdRootNodeMap=new Map();this._materialMap=new Map();this._materialNodesMap=new Map();this._nodes=new Map();this._views=new Map();this._geometries=new Map();this._geometryMeshes=new Map();this._meshNodes=new Map();this._meshSubmeshes=new Map();this._yIndex=1;};S.prototype.setScene=function(i){if(i.result!==1){var j={status:i.result};switch(i.result){case-1:j.errorText=g().getText("LOADER_FILENOTFOUND");break;case-2:j.errorText=g().getText("LOADER_WRONGFILEFORMAT");break;case-3:j.errorText=g().getText("LOADER_WRONGPASSWORD");break;case-4:j.errorText=g().getText("LOADER_ERRORREADINGFILE");break;case-5:j.errorText=g().getText("LOADER_FILECONTENT");break;default:j.errorText=g().getText("LOADER_UNKNOWNERROR");}this._reject(j);}else{this._yIndex=1;var k=this._cameras.get(i.cameraId);L.info("setScene",JSON.stringify(i),k);this._resolve({node:this._rootNode,camera:k,backgroundTopColor:i.backgroundTopColor,backgroundBottomColor:i.backgroundBottomColor,contentResource:this._contentResource,builder:this});}};S.prototype.setRootNode=function(r,n,s,v){this._rootNode=r;this._nodes.set(n,r);if(s){this._sceneIdTreeNodesMap.set(s,this._nodes);this._sceneIdRootNodeMap.set(s,r);this._currentSceneId=s;}if(v){this._vkScene=v;}return this;};S.prototype.setNodePersistentId=function(n,i,s){this._resetCurrentScene(s);n.sid=i;this._nodes.set(i,n);return true;};S.prototype.cleanup=function(){this._rootNode=null;this._currentSceneId=null;if(this._nodes){this._nodes.clear();}if(this._viewGroups){this._viewGroups.clear();}if(this._views){this._views.clear();}this._materialMap.clear();this._materialNodesMap.clear();this._sceneIdTreeNodesMap.clear();this._sceneIdRootNodeMap.clear();};S.prototype.getNode=function(n,s){if(s){this._resetCurrentScene(s);if(this._nodes){return this._nodes.get(n);}}else{var i=this._sceneIdTreeNodesMap.values();var j=i.next();while(!j.done){var k=j.value.get(n);if(k){return k;}j=i.next();}}return null;};S.prototype._resetCurrentScene=function(s){if(s&&s!==this._currentSceneId){var n=this._sceneIdTreeNodesMap.get(s);if(n){this._nodes=n;}else{this._nodes=new Map();}var i=this._sceneIdRootNodeMap.get(s);if(i){this._rootNode=i;}else{this._rootNode=null;}this._currentSceneId=s;}};S.prototype.createCamera=function(i,s){this._resetCurrentScene(s);this._cameras.set(i.id,i);return null;};S.prototype.getCamera=function(i){return null;};S.prototype.hasMesh=function(m){return this._meshSubmeshes.has(m);};function f(l){if(Array.isArray(l)){for(var i=0;i<l.length;i++){if(l[i].type===undefined||l[i].type==="mesh"||l[i].type==="line"){return l[i];}}}return null;}S.prototype.setMeshNode=function(n,m){this._setMeshNode(this._nodes.get(n),m);};S.prototype.setModelViewVisibilitySet=function(){};S.prototype.setAnimationPlaybacks=function(){};S.prototype.loadingFinished=function(i){L.info("loadingFinished",JSON.stringify(i));this._loader.fireContentLoadingFinished({source:this._contentResource,node:this._rootNode});};S.prototype.createThumbnail=function(){};S.prototype.insertSubmesh=function(s){if(!s.lods){return false;}var l=f(s.lods);if(!l){return false;}s.boundingBox=l.boundingBox;var i=this._geometries.get(l.id);if(i){var n=this._meshNodes.get(s.meshId);if(n){for(var j=0;j<n.length;j++){this._addGeometryToNode(n[j],i,s);}}}else{d.pushElementIntoMapArray(this._geometryMeshes,l.id,s);}d.pushElementIntoMapArray(this._meshSubmeshes,s.meshId,s);};S.prototype.insertViewGroup=function(i,s){return this;};S.prototype.insertView=function(v,s){this._resetCurrentScene(s);var i=new V();i.setViewId(v.viewId);i.setName(v.name);i.userData={viewInfo:v};this._views.set(v.viewId,i);return this;};S.prototype.getView=function(v,s){this._resetCurrentScene(s);return this._views.get(v);};S.prototype.setViewCamera=function(i,v,s){return this;};S.prototype.getChildNodeIds=function(n,s,j){this._resetCurrentScene(s);var k=this._nodes.get(n);var l=[];if(!k){return l;}if(k&&k.children){for(var i=0;i<k.children.length;i++){var m=k.children[i];if(m.userData.treeNode&&m.userData.treeNode.sid){l.push(m.userData.treeNode.sid);}else if(j&&m.userData.submeshInfo&&m.userData.submeshInfo.id){l.push(m.userData.submeshInfo.id);}}}return l;};S.prototype.setViewNodeInfos=function(n,v,s){this._resetCurrentScene(s);var i=this._views.get(v);i.setNodeInfos(n);return this;};S.prototype.finalizeViewGroups=function(s){return this;};S.prototype.setVoxelThreshold=function(v){return this;};S.prototype.getVoxelThreshold=function(){return 0.0;};function e(m){if(m){if(m.length===12){return[m[0],m[1],m[3],m[4],m[9],m[10]];}else if(m.length===16){return[m[0],m[1],m[4],m[5],m[12],m[13]];}}}S.prototype.createNode=function(n,s){this._resetCurrentScene(s);var t=n.transform;var i=new E({sid:n.sid,name:n.name,matrix:e(t)});this._nodes.set(n.sid,i);var u=i.userData;if(n.metadata){u.metadata=n.metadata;}if(n.veids){u.veids=n.veids;}if(n.parametricId){u.parametricId=n.parametricId;}else if(n.meshId){this._setMeshNode(i,n.meshId);}u.treeNode=n;i.setVisible(1,n.visible?n.visible:true);if(n.visualisable===false){u.skipIt=true;}var p=this._nodes.get(n.parentId);(p||this._rootNode).add(i);return i;};S.prototype.createAnnotation=function(i,s){};S.prototype.remove=function(n,s){this._resetCurrentScene(s);var t=this;n=[].concat(n);n.forEach(function(j){var k=t._nodes.get(j);if(k){t._nodes.delete(j);for(var i=0;i<k.children.length;i++){var l=k.children[i];if(l.userData&&l.userData.treeNode&&l.userData.treeNode.sid){t.remove(l.userData.treeNode.sid,s);}}}});return this;};S.prototype._addPolylineSegment=function(s,j,p){var k=j.length;if(k<2){return;}var m=[];var n=j[0]===j[k-1];if(n){k--;}for(var i=0,l=j.length;i<l;i++){var q=j[i]*3;m.push(p[q],p[q+this._yIndex]);}s.push({type:"polyline",points:m,closed:n});};S.prototype._addGeometryToNode=function(n,j,s){var m=s.materialId;var k=this._getMaterial(m);var p=j.data;var q=p.indices;var r=p.points;var t=new Float32Array([1,0,0,1,0,0]);if(j.isPositionQuantized&&s.boundingBox){}if(s.transform){}var i,u,v,w;var l=q.length;var x=[];if(j.isPolyline){k=Object.assign(Object.assign({},k),{color:[0,0,0,0]});var y=[];for(i=0,u=-1;i<l;i+=2,u=w){v=q[i];w=q[i+1];if(v!==u){this._addPolylineSegment(x,y,r);y.length=0;y.push(v);}y.push(w);}this._addPolylineSegment(x,y,r);}else{k=Object.assign(Object.assign({},k),{lineColor:[0,0,0,0],lineWidth:0});var z=[];for(i=0;i<l;i+=3){u=q[i]*3;v=q[i+1]*3;w=q[i+2]*3;z.push(r[u],r[u+this._yIndex],r[v],r[v+this._yIndex],r[w],r[w+this._yIndex]);}x.push({type:"mesh",points:z});}var A=new c({segments:x,isTriangleMesh:!j.isPolyline,matrix:t,material:k,materialID:m,subelement:true});A.uid+="-g";n.add(A);d.pushElementIntoMapArray(this._materialNodesMap,m,A);n.rerender();};S.prototype.setGeometry=function(i){this._geometries.set(i.id,i);var j=this._geometryMeshes.get(i.id);if(j){for(var m=0;m<j.length;m++){var s=j[m];var n=this._meshNodes.get(s.meshId);if(n){for(var k=0;k<n.length;k++){this._addGeometryToNode(n[k],i,s);}}}}if(this._fireSceneUpdated){this._fireSceneUpdated();}return this;};S.prototype._setMeshNode=function(n,m){d.pushElementIntoMapArray(this._meshNodes,m,n);var s=this._meshSubmeshes.get(m);if(s){for(var i=0;i<s.length;i++){var j=s[i];var l=f(j.lods);if(l){var k=this._geometries.get(l.id);if(k){this._addGeometryToNode(n,k,j);}}}}};function h(s){var m=new Float32Array([1,0,0,1,0,0]);if(s.t){m[4]=s.t[0];m[5]=s.t[1];}if(s.r){var x=s.r[0],y=s.r[1],z=s.r[2],w=s.r[3];var i=x*y;var j=z*z;var k=w*z;m[0]=1-(y*y+j)*2;m[1]=(i+k)*2;m[2]=(i-k)*2;m[3]=1-(x*x+j)*2;}if(s.s){m[0]*=s.s[0];m[1]*=s.s[0];m[2]*=s.s[1];m[3]*=s.s[1];}return m;}function o(s){var j=[];var m;function k(){if(j.length>0){j.forEach(function(w){var r=w.points;if(r&&r.length>=4&&r[0]===r[r.length-2]&&r[1]===r[r.length-1]){w.closed=true;r.length-=2;}});s.push({type:"path",segments:j,materialID:m});j=[];}}var l;var i=0;while(i<s.length){var n=s[i];if(n.type==="line"){if(m!==n.materialID){k();m=n.materialID;}l=h(n);var x=n.x1*l[0]+n.y1*l[2]+l[4];var y=n.x1*l[1]+n.y1*l[3]+l[5];var p=n.x2*l[0]+n.y2*l[2]+l[4];var q=n.x2*l[1]+n.y2*l[3]+l[5];var r=j.length>0?j[j.length-1].points:null;if(r&&r[r.length-2]===x&&r[r.length-1]===y){r.push(p,q);}else{j.push({type:"polyline",points:[x,y,p,q]});}s.shift();}else if(n.type==="arc"){if(m!==n.materialID){k();m=n.materialID;}l=h(n);n.cx=n.cx||0;n.cy=n.cy||0;var t=n.cx*l[0]+n.cy*l[2]+l[4];var u=n.cx*l[1]+n.cy*l[3]+l[5];if(n.r){var v=Math.atan2(l[1],l[0]);n.start+=v;n.end+=v;}j.push({type:"arc",cx:t,cy:u,rx:(n.major||n.radius)*(n.s?n.s[0]:1),ry:(n.minor||n.radius)*(n.s?n.s[1]:1),start:n.start>n.end?n.start-Math.PI*2:n.start,end:n.end});s.shift();}else{i++;}}k();}S.prototype.setParametricContent=function(n,p,s){if(p==null){L.warning("Empty parametric content for node "+n);return;}this._resetCurrentScene(s);var j=this._nodes.get(n);j.uid+="-p";if(p.shapes){o(p.shapes);for(var i=0;i<p.shapes.length;i++){var k=p.shapes[i];k.matrix=h(k);k.subelement=true;var l=this._createObject(k);if(l){l.userData.po=p;l.uid+="-s";j.add(l);if(k.materialID){d.pushElementIntoMapArray(this._materialNodesMap,k.materialID,l);}}}j.rerender();}else{p.sid=n;p.name=j.name;p.matrix=E._multiplyMatrices(j.matrix,h(p));var m=this._createObject(p);if(m){m.uid+="-ps";m.userData.po=p;j.add(m);j.rerender();if(p.materialID){d.pushElementIntoMapArray(this._materialNodesMap,p.materialID,m);}}}};S.prototype._createObject=function(p){p.material=this._getMaterial(p.materialID);switch(p.type){case"arc":case"ellipticalArc":p.segments=[{type:"arc",cx:p.cx||0,cy:p.cy||0,rx:p.major||p.radius,ry:p.minor||p.radius,start:p.start>p.end?p.start-Math.PI*2:p.start,end:p.end}];return new c(p);case"rectangle":return new R(p);case"line":return new b(p);case"polyline":return new P(p);case"ellipse":case"circle":return new a(p);case"text":return new T(p);case"path":return new c(p);default:L.warning("Unsupported parametric type",p.type);return null;}};S.prototype.createMaterial=function(m){var i=m.id;var k=this._getMaterial(i);k.lineColor=m.lineColour;k.lineWidth=m.lineWidth||1;k.lineStyle={width:m.lineWidth||1,haloWidth:m.lineHaloWidth||0,endCapStyle:m.lineEndRound?1:0,dashPattern:m.lineDashPattern||[],dashPatternScale:m.lineDashPatternScale,widthCoordinateSpace:m.lineWidthCoordinateSpace};if(m.emissiveColour){k.color=m.emissiveColour;}if(m.opacity!==undefined){k.opacity=m.opacity;}var n=this._materialNodesMap.get(i);if(n){for(var j=0;j<n.length;j++){n[j].setMaterial(k,true);}}return[];};S.prototype._getMaterial=function(m){return this._materialMap.get(m)||this._createTemporaryMaterial(m);};S.prototype._createTemporaryMaterial=function(m){var i={materialId:m,lineColor:[0,0,0,1],lineWidth:1};this._materialMap.set(m,i);return i;};S.prototype.checkMaterialExists=function(m,t){if(!this._materialMap.get(m)){if(t){this._createTemporaryMaterial(m);}return false;}return true;};return S;});
