/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["sap/base/Log","../ContentManager","./Scene","./SceneBuilder","./Element","../Messages","../getResourceBundle","./Viewport","./ViewStateManager"],function(L,C,S,a,E,M,g){"use strict";var b=C.extend("sap.ui.vk.svg.ContentManager",{metadata:{library:"sap.ui.vk",events:{errorReported:{parameters:{error:{type:"any"}}}}}});var c=b.getMetadata().getParent().getClass().prototype;b.prototype.init=function(){if(c.init){c.init.call(this);}};b.prototype.exit=function(){if(this.defaultCdsLoader){this.defaultCdsLoader.destroy();this.defaultCdsLoader=null;}if(c.exit){c.exit.call(this);}};b.prototype._handleContentChangesProgress=function(e){this.fireContentChangesProgress({phase:e.getParameter("phase"),source:e.getParameter("source"),percentage:e.getParameter("percentage")});};b.prototype._handleContentLoadingFinished=function(e){this.fireContentLoadingFinished({source:e.getParameter("source"),node:e.getParameter("node")});};b.prototype.loadContent=function(d,e){var t=this;var l=function(){t.fireContentChangesStarted();var s=new S();t._loadContentResources(s,e).then(function(v){L.info("Content loading resolved",v);for(var i=0;i<v.length;i++){if(v[i].camera){s.camera=v[i].camera;break;}}if(t._totaraLoader){s.setSceneBuilder(t._totaraLoader.getSceneBuilder());}t.fireContentChangesFinished({content:s});},function(r){L.info("Content loading rejected:",r);var f;if(typeof r==="string"){f=r;}else if(r.errorText){f=r.errorText;}else if(r.message){f=r.message;}f=f||g().getText(M.VIT37.summary);L.error(g().getText("CONTENTMANAGER_MSG_CONTENTRESOURCESFAILEDTOLOAD"),f);t.fireContentChangesFinished({content:null,failureReason:[{error:r,errorMessage:f}]});});};l();return this;};b.prototype._getTotaraLoader=function(){if(this._totaraLoader==null){return new Promise(function(r){var t="sap/ui/vk/totara/TotaraLoader";sap.ui.require([t],function(d){var l=new d();l.setSceneBuilder(new a());r(l);});});}return Promise.resolve(this._totaraLoader);};b.prototype._getMataiLoader=function(){if(this._mataiLoader==null){var t=this;return new Promise(function(r){var m="sap/ui/vk/matai/MataiLoader";sap.ui.require([m],function(d){r(t._mataiLoader=new d());});});}return Promise.resolve(this._mataiLoader);};b.prototype._createLoadParam=function(r,d,p,e){var t=this;var i;var s=false;var f;if(this._currentNodeHierarchy){f=this._currentNodeHierarchy.getScene();}var h={root:p,includeHidden:e.getIncludeHidden(),pushPMI:true,includeBackground:e.getIncludeBackground(),includeParametric:true,includeAnimation:false,metadataFilter:e.getMetadataFilter(),useSecureConnection:e.getUseSecureConnection(),enableLogger:e.getEnableLogger()===true,vkScene:f,onActiveCamera:function(n){i=n;},onInitialSceneFinished:function(){s=true;r({node:p,contentResource:e,camera:i});},onLoadingFinished:function(){t.fireContentLoadingFinished({source:e,node:p});},onContentChangesProgress:function(k){t.fireContentChangesProgress({source:k.source,phase:k.phase,percentage:k.percentage});}};var j=function(k){L.warning("Content loading error reported:",JSON.stringify(k.getParameters()));var l;if(k.getParameter("errorText")){l=k.getParameter("errorText");}else if(k.getParameter("error")){l=k.getParameter("error");}else if(k.getParameter("reason")){l=k.getParameter("reason");}else{l="failed to load: unknown reason";}if(s){var m=k.getParameter("error");if(m&&m===4){t.initUrl(this._loader.getUrl(),true);}}else{t.detachErrorReported(j);if(k.getParameter("events")){l=l+"\n"+JSON.stringify(k.getParameter("events"));}d(l);}};t.attachErrorReported(j);return h;};b.prototype._reportError=function(e){this.fireErrorReported(e);};b.prototype._loadStream=function(p,d){var t=this;return new Promise(function(r,e){t._getTotaraLoader().then(function(l){t._totaraLoader=l;var f=t._createLoadParam(r,e,p,d);l.onErrorCallbacks.attach(t._reportError.bind(t));l.setUrl(d.getSource());l.run();l.request(d.getVeid(),f,t._authorizationHandler);});});};b.prototype._loadVDS4=function(p,d){var t=this;return this._getMataiLoader().then(function(l){if(l){l.attachContentChangesProgress(t._handleContentChangesProgress,t);l.attachContentLoadingFinished(t._handleContentLoadingFinished,t);return l.load(p,d);}else{return Promise.resolve({node:p,contentResource:d});}});};b.prototype._loadContentResources=function(s,d){var p=[];d.forEach(function l(e,f){var h=new E();h.name=f.getName();h.sourceId=f.getSourceId();e.add(h);var i=f._contentManagerResolver;var j=i&&i.settings?i.settings.loader:null;if(j){p.push(j(h,f));}else{var k=f.getSourceType();switch(k?k.toLowerCase():null){case"stream2d":{h.matrix=new Float32Array([1,0,0,-1,0,0]);p.push(this._loadStream(h,f));break;}case"vds4-2d":{h.matrix=new Float32Array([1,0,0,-1,0,0]);p.push(this._loadVDS4(h,f));break;}default:break;}}}.bind(this,s.getRootElement()));return Promise.all(p);};return b;});
