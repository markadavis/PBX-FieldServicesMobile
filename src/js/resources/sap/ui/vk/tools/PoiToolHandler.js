sap.ui.define(["sap/ui/base/EventProvider","../thirdparty/three"],function(E,t){"use strict";var P=E.extend("sap.ui.vk.tools.PoiToolHandler",{metadata:{},constructor:function(a){this._priority=30;this._tool=a;this._gizmo=a.getGizmo();this._rect=null;this._rayCaster=new THREE.Raycaster();this._handleIndex=-1;this._gizmoIndex=-1;this._handleAxis=new THREE.Vector3();this._gizmoOrigin=new THREE.Vector3();this._gizmoScale=1;this._objectSpace=new THREE.Matrix4();this._mouse=new THREE.Vector2();}});P.prototype._updateMouse=function(e){var s=this.getViewport().getRenderer().getSize(new THREE.Vector2());this._mouse.x=((e.x-this._rect.x)/s.width)*2-1;this._mouse.y=((e.y-this._rect.y)/s.height)*-2+1;this._rayCaster.setFromCamera(this._mouse,this.getViewport().getCamera().getCameraRef());};P.prototype._updateHandles=function(e,h){this._handleIndex=-1;if(e.n===1||(e.event&&e.event.type==="contextmenu")){for(var i=0,l=this._gizmo.getGizmoCount();i<l;i++){var a=this._gizmo.getTouchObject(i);var v=this._tool._viewport.getDomRef().getBoundingClientRect();var s=e.x-v.left;var b=e.y-v.top;var c=this._tool._viewport.hitTest(s,b);var f=this._tool.getSelectedPois();if(c&&c.object&&f.includes(c.object)){this._handleIndex=5;this._gizmoIndex=i;this._gizmoOrigin.setFromMatrixPosition(a.matrixWorld);this._gizmoScale=a.scale.x;this._objectSpace.extractRotation(a.matrixWorld);this._objectSpace.copyPosition(a.matrixWorld);this._handleAxis.setFromMatrixColumn(a.matrixWorld,this._handleIndex-3).normalize();}}}};P.prototype.hover=function(e){if(this._inside(e)&&!this._gesture){this._updateMouse(e);this._updateHandles(e,true);e.handled|=this._handleIndex>=0;}};P.prototype.click=function(e){if(this._inside(e)&&!this._gesture){this._updateMouse(e);this._updateHandles(e,true);this._gizmo.selectHandle(this._handleIndex,this._gizmoIndex);e.handled|=this._handleIndex>=0;}};var d=new THREE.Vector3();P.prototype._getPlaneOffset=function(){var r=this._rayCaster.ray;d.copy(this._gizmoOrigin).sub(r.origin);var a=this._handleAxis.dot(d)/this._handleAxis.dot(r.direction);return r.direction.clone().multiplyScalar(a).sub(d);};P.prototype.beginGesture=function(e){if(this._inside(e)&&!this._gesture){this._updateMouse(e);this._updateHandles(e,false);if(this._handleIndex>=0){this._gesture=true;e.handled=true;this._gizmo.selectHandle(this._handleIndex,this._gizmoIndex);this._gizmo.beginGesture();this._dragOrigin=this._getPlaneOffset();}}};P.prototype._setOffset=function(o){if(isFinite(o.x)&&isFinite(o.y)&&isFinite(o.z)){this._gizmo._setOffset(o,this._gizmoIndex);}};P.prototype.move=function(e){if(this._gesture){e.handled=true;this._updateMouse(e);if(isFinite(this._dragOrigin.x)&&isFinite(this._dragOrigin.y)&&isFinite(this._dragOrigin.z)){this._setOffset(this._getPlaneOffset().sub(this._dragOrigin));}}};P.prototype.endGesture=function(e){if(this._gesture){this._gesture=false;e.handled=true;this._updateMouse(e);this._gizmo.endGesture();this._dragOrigin=undefined;this._updateHandles(e,true);this.getViewport().setShouldRenderFrame();}};P.prototype.getViewport=function(){return this._tool._viewport;};P.prototype._getOffset=function(o){var r=o.getBoundingClientRect();var p={x:r.left+window.pageXOffset,y:r.top+window.pageYOffset};return p;};P.prototype._inside=function(e){if(this._rect===null||true){var i=this._tool._viewport.getIdForLabel();var a=document.getElementById(i);if(a===null){return false;}var o=this._getOffset(a);this._rect={x:o.x,y:o.y,w:a.offsetWidth,h:a.offsetHeight};}return(e.x>=this._rect.x&&e.x<=this._rect.x+this._rect.w&&e.y>=this._rect.y&&e.y<=this._rect.y+this._rect.h);};return P;});
