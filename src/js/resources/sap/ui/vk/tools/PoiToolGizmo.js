/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../thirdparty/three","./Gizmo","./PoiToolGizmoRenderer","./CoordinateSystem","./GizmoPlacementMode"],function(q,t,G,M,C,a){"use strict";var P=G.extend("sap.ui.vk.tools.PoiToolGizmo",{metadata:{library:"sap.ui.vk"}});P.prototype.init=function(){if(G.prototype.init){G.prototype.init.apply(this);}this._gizmoIndex=-1;this._handleIndex=-1;this._moveDelta=new THREE.Vector3();this._viewport=null;this._tool=null;this._sceneGizmo=new THREE.Scene();this._gizmo=new THREE.Group();this._touchAreas=new THREE.Group();this._sceneGizmo.add(this._gizmo);this._coordinateSystem=C.Local;this._placementMode=a.ObjectCenter;this._nodes=[];this._matViewProj=new THREE.Matrix4();this._gizmoSize=96;};P.prototype.hasDomElement=function(){return true;};P.prototype.show=function(v,b){this._viewport=v;this._tool=b;this._nodes.length=0;this._updateSelection(v._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);};P.prototype.hide=function(){this._cleanTempData();this._viewport=null;this._tool=null;this._gizmoIndex=this._handleIndex=-1;};P.prototype.getGizmoCount=function(){return this._nodes.length;};P.prototype.getTouchObject=function(i){if(this._nodes.length===0){return null;}this._updateGizmoObjectTransformation(this._touchAreas,i,true);return this._touchAreas;};P.prototype.selectHandle=function(i,g){this._gizmoIndex=g;this._handleIndex=i;this._viewport.setShouldRenderFrame();};P.prototype.beginGesture=function(){this._moveDelta.setScalar(0);this._matOrigin=this._gizmo.matrixWorld.clone();this._nodes.forEach(function(n){var b=n.node;n.matOrigin=b.matrixWorld.clone();n.originLocal=b.position.clone();n.origin=new THREE.Vector3().setFromMatrixPosition(b.matrixWorld);if(b.parent){n.matParentInv=new THREE.Matrix4().getInverse(b.parent.matrixWorld);}else{n.matParentInv=new THREE.Matrix4();}});};P.prototype._getNodesProperties=function(){var n=[];this._nodes.forEach(function(b){n.push({node:b.node});});return n;};P.prototype.endGesture=function(){var n=this._getNodesProperties();var o=this._moveDelta.clone();if(this._coordinateSystem===C.Custom){var g=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);var b=new THREE.Matrix4().getInverse(g);o.applyMatrix4(b);}this._tool.fireMoved({x:o.x,y:o.y,z:o.z,nodesProperties:n});};P.prototype._setOffset=function(o,g){var n=this._nodes[g];var b=n.node;var m=new THREE.Matrix4().getInverse(b.matrixWorld);var s=new THREE.Vector3().setFromMatrixScale(b.matrixWorld);var c=n.origin.clone().applyMatrix4(m);o=n.origin.clone().add(o).applyMatrix4(m).sub(c).multiply(s);var d=this._getNodesProperties();var e=o.clone();if(this._coordinateSystem===C.Custom){var f=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);var h=new THREE.Matrix4().getInverse(f);e.applyMatrix4(h);}if(this._tool.fireEvent("moving",{x:e.x,y:e.y,z:e.z,nodesProperties:d},true)){this._move(o);}};P.prototype._move=function(o){this._moveDelta.copy(o);this._nodes.forEach(function(n){var b=n.node;var c=this._extractBasis(b.matrixWorld);var p=n.origin.clone();p.add(c[0].multiplyScalar(o.x)).add(c[1].multiplyScalar(o.y)).add(c[2].multiplyScalar(o.z));b.matrixWorld.setPosition(p);b.matrix.multiplyMatrices(n.matParentInv,b.matrixWorld);b.position.setFromMatrixPosition(b.matrix);b.matrixWorldNeedsUpdate=true;}.bind(this));this._viewport.setShouldRenderFrame();};P.prototype.move=function(x,y,z){this.beginGesture();if(this._coordinateSystem===C.Custom){var o=new THREE.Vector3(x,y,z);var g=new THREE.Matrix4().extractRotation(this._gizmo.matrixWorld);o.applyMatrix4(g);x=o.x;y=o.y;z=o.z;}this._move(new THREE.Vector3(x,y,z||0));};P.prototype.expandBoundingBox=function(b){if(this._viewport){this._expandBoundingBox(b,this._viewport.getCamera().getCameraRef(),this._viewport._getLayers());}};P.prototype.handleSelectionChanged=function(e){if(this._viewport){this._updateSelection(this._viewport._viewStateManager);var n=this._getNodesProperties();this._tool.fireEvent("moving",{x:0,y:0,z:0,nodesProperties:n},true);this._gizmoIndex=this._handleIndex=-1;}};P.prototype._getSelectionCenter=function(b){G.prototype._getSelectionCenter.apply(this,arguments);var c=new THREE.Vector3();if(this._nodes[0].node.userData.boundingBox){this._nodes[0].node.userData.boundingBox.getCenter(c);}else{var d=new THREE.Box3();d.expandByObject(this._nodes[0].node);d.getCenter(c);}b.copy(c.applyMatrix4(this._nodes[0].node.matrixWorld));};P.prototype._updateGizmoTransformation=function(i,c){this._updateGizmoObjectTransformation(this._gizmo,i,true);};P.prototype._updatePoiButtons=function(){this._tool.updateButtons();};P.prototype.render=function(){if(this._nodes.length>0){var r=this._viewport.getRenderer(),c=this._viewport.getCamera().getCameraRef();this._matViewProj.multiplyMatrices(c.projectionMatrix,c.matrixWorldInverse);r.clearDepth();for(var i=0,l=this.getGizmoCount();i<l;i++){this._updateGizmoTransformation(i,c);}}this._updatePoiButtons();};return P;});
