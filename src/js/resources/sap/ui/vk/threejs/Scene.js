/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["jquery.sap.global","../Scene","./NodeHierarchy","../RenderMode","./ThreeExtensions","./ThreeUtils"],function(q,S,N,R,T,c){"use strict";var d=S.extend("sap.ui.vk.threejs.Scene",{metadata:{},constructor:function(a){S.call(this);this._id=q.sap.uid();this._scene=a;this._sceneBuilder=null;this._defaultNodeHierarchy=null;this._currentViewStateManager=null;this._animationSequenceMap=new Map();this._initialView=null;this._materialMap=new Map();this._layersMask=(1|0);}});d.prototype.init=function(){this._outlineColor=new THREE.Vector4(0,0,0,1);this._outlineMaterial=new THREE.ShaderMaterial({uniforms:{color:{value:this._outlineColor}},vertexShader:["attribute vec3 normal1;","attribute vec3 normal2;","#include <clipping_planes_pars_vertex>","uniform vec4 color;","varying vec4 vColor;","void main() {","	#include <begin_vertex>","	#include <project_vertex>","	#include <clipping_planes_vertex>","	vec3 eyeDirection = mvPosition.xyz;","	vec3 n1 = normalMatrix * normal1;","	vec3 n2 = normalMatrix * normal2;","	vColor = color;","	vColor.a *= step(dot(eyeDirection, n1) * dot(eyeDirection, n2), 0.0);","}"].join("\n"),fragmentShader:["#include <clipping_planes_pars_fragment>","varying vec4 vColor;","void main() {","	#include <clipping_planes_fragment>","	if (vColor.a < ALPHATEST) discard;","	gl_FragColor = vColor;","}"].join("\n"),depthWrite:false,depthFunc:THREE.LessEqualDepth,polygonOffset:true,polygonOffsetFactor:-4,blending:THREE.NormalBlending,alphaTest:0.01,clipping:true});this._solidWhiteMaterial=new THREE.MeshBasicMaterial({color:0xFFFFFF});};d.prototype.clearThreeScene=function(){if(!this._scene){return;}var a=[];var b=[];c.getAllTHREENodes([this._scene],a,b);var e=new Map();var i=new Map();a.forEach(function(j){if(j instanceof THREE.Mesh){if(!e.has(j.geometry.uuid)){c.disposeGeometry(j);e.set(j.geometry.uuid,true);}if(j.material){if(!i.has(j.material.uuid)){c.disposeMaterial(j.material);i.set(j.material.uuid,true);}}if(j.userData&&j.userData.originalMaterial&&j.userData.originalMaterial.uuid!==j.material.uuid&&!i.has(j.userData.originalMaterial.uuid)){c.disposeMaterial(j.userData.originalMaterial);i.set(j.userData.originalMaterial.uuid,true);}}j.parent.remove(j);});b.forEach(function(j){j.parent.remove(j);});e.clear();i.clear();};d.prototype.destroy=function(){this.clearThreeScene();if(this._defaultNodeHierarchy){this._defaultNodeHierarchy.destroy();this._defaultNodeHierarchy=null;}c.disposeMaterial(this._solidWhiteMaterial);c.disposeMaterial(this._outlineMaterial);this._sceneBuilder=null;if(this._scene){this._scene.dispose();}this._scene=null;this._currentViewStateManager=null;this._animationSequenceMap.clear();this._materialMap.clear();S.prototype.destroy.call(this);};d.prototype.setDoubleSided=function(v){this.setProperty("doubleSided",v,true);this._scene.traverse(function(a){if(a.material!==undefined){var u=a.userData;var b=THREE.FrontSide;var e;if(u.originalMaterial){if(u.originalMaterial.userData===undefined){u.originalMaterial.userData={};}e=u.originalMaterial.userData;if(e.originalMaterialSide===undefined){e.originalMaterialSide=u.originalMaterial.side;}b=e.originalMaterialSide;}else{if(a.material.userData===undefined){a.material.userData={};}e=a.material.userData;if(e.originalMaterialSide===undefined){e.originalMaterialSide=a.material.side;}b=e.originalMaterialSide;}a.material.side=v?THREE.DoubleSide:b;}});return this;};d.prototype.setViewStateManager=function(v){this._currentViewStateManager=v;return this;};d.prototype.getViewStateManager=function(){return this._currentViewStateManager;};d.prototype.getId=function(){return this._id;};d.prototype.getDefaultNodeHierarchy=function(){if(!this._defaultNodeHierarchy){this._defaultNodeHierarchy=new N(this);}return this._defaultNodeHierarchy;};d.prototype._computeBoundingBox=function(v,i,a){var b=new THREE.Box3();if(this._scene){this._scene._expandBoundingBox(b,v,i,a);}return b;};d.prototype.getSceneRef=function(){return this._scene;};d.prototype.setSceneBuilder=function(a){this._sceneBuilder=a;};d.prototype.getSceneBuilder=function(){return this._sceneBuilder;};d.prototype.nodeRefToPersistentId=function(a){return Array.isArray(a)?a.map(function(b){return b._vkPersistentId();}):a._vkPersistentId();};d.prototype.persistentIdToNodeRef=function(a){var b=this._sceneBuilder;if(Array.isArray(a)){return a.map(function(e){return b?b.getNode(e):null;});}else{return b?b.getNode(a):null;}};d.prototype.setNodePersistentId=function(a,b,e){return this._sceneBuilder?this._sceneBuilder.setNodePersistentId(a,b,e):false;};d.prototype.setAnnotationPersistentId=function(a,b,e){return this._sceneBuilder?this._sceneBuilder.setAnnotationPersistentId(a,b,e):false;};d.prototype.enumerateMaterials=function(){if(!this._defaultNodeHierarchy){return[];}var a=this._defaultNodeHierarchy.createNodeProxy(this._scene);if(a){return a.enumerateMaterials(true);}else{return[];}};var f=0;function g(a,b){var e=a.x-b.x;if(e<-f){return true;}if(e>f){return false;}var i=a.y-b.y;if(i<-f){return true;}if(i>f){return false;}return a.z-b.z<-f;}function h(a,b,e){if(b<e){var i=p(a,b,e);h(a,b,i-1);h(a,i+1,e);}return a;}function p(a,b,e){var j=a[e],l=b;for(var i=b;i<e;i++){if(g(a[i],j)){s(a,i,l);l++;}}s(a,e,l);return l;}function s(a,i,j){if(i!=j){var b=a[i];a[i]=a[j];a[j]=b;}}var k=new THREE.Vector3();function m(a){a.computeBoundingBox();a.boundingBox.getSize(k);f=Math.max(k.x,k.y,k.z)*1e-4;var v=a.vertices,b=v.length,e=a.faces.length;if(b===0||e===0){return;}var i,j;for(i=0;i<b;i++){v[i].index=i;}h(v,0,v.length-1);var u=[],l=[];u.push(v[0]);l[v[0].index]=u.length-1;for(i=1;i<b;i++){if(g(u[u.length-1],v[i])){u.push(v[i]);}l[v[i].index]=u.length-1;}a.vertices=u;for(i=0,e=a.faces.length,j=0;i<e;i++){var w=a.faces[i];var x=a.faces[j];x.a=l[w.a];x.b=l[w.b];x.c=l[w.c];if(x.a!==x.b&&x.b!==x.c&&x.c!==x.a){j++;}}a.faces.length=j;}function O(a,b){THREE.BufferGeometry.call(this);this.type="OutlineGeometry";var u=Math.cos(THREE.Math.DEG2RAD*((b!==undefined)?b:1));var w={},x,y;var z,A=["a","b","c"];var v=new THREE.Vector3();var B;if(a.isBufferGeometry){B=new THREE.Geometry();B.fromBufferGeometry(a);}else{B=a.clone();}m(B);B.computeFaceNormals();var C=B.vertices;var D=B.faces;for(var E=0,l=D.length;E<l;E++){var F=D[E];for(var i=0,j=2;i<3;j=i++){x=F[A[j]];y=F[A[i]];z=Math.min(x,y)+","+Math.max(x,y);if(w[z]===undefined){w[z]={index1:x,index2:y,face1:E,face2:undefined};}else{w[z].face2=E;}}}var G=[];var H=[];var I=[];for(z in w){var e=w[z];if(e.face2===undefined||(D[e.face1].normal.dot(D[e.face2].normal)<=u&&v.copy(C[e.index2]).sub(C[e.index1]).cross(D[e.face1].normal).dot(D[e.face2].normal)>0)){var J=C[e.index1];G.push(J.x,J.y,J.z);J=C[e.index2];G.push(J.x,J.y,J.z);var K=D[e.face1].normal;H.push(K.x,K.y,K.z);H.push(K.x,K.y,K.z);if(e.face2!==undefined){var L=D[e.face2].normal;I.push(L.x,L.y,L.z);I.push(L.x,L.y,L.z);}else{I.push(0,0,0);I.push(0,0,0);}}}this.setAttribute("position",new THREE.Float32BufferAttribute(G,3));this.setAttribute("normal1",new THREE.Float32BufferAttribute(H,3));this.setAttribute("normal2",new THREE.Float32BufferAttribute(I,3));}O.prototype=Object.create(THREE.BufferGeometry.prototype);O.prototype.constructor=O;function n(b){return(b===null)||(b.min.x>=b.max.x&&b.min.y>=b.max.y&&b.min.z>=b.max.z);}function o(a){var b=null;if(a.isMesh&&a.geometry&&!n(a.geometry.boundingBox)&&(a.layers!==a.parent.layers)){b=a.geometry;if(b.isBufferGeometry){b=new THREE.Geometry().fromBufferGeometry(b);}}for(var i=0,l=a.children.length;i<l;i++){var e=a.children[i];if(e.isMesh&&e.geometry&&!n(e.geometry.boundingBox)&&e.layers===a.layers){if(b===null){b=new THREE.Geometry();}var j=e.geometry;if(j.isBufferGeometry){j=new THREE.Geometry().fromBufferGeometry(j);}b.merge(j,e.matrix);}}return b;}function r(a,b){var u=a.userData;if(u.defaultMaterial===undefined){u.defaultMaterial=u.originalMaterial||a.material;}a.material=b;u.originalMaterial=null;a._vkUpdateMaterialColor();a._vkUpdateMaterialOpacity();}function t(a){var u=a.userData;if(u.defaultMaterial){a.material=u.defaultMaterial;delete u.defaultMaterial;u.originalMaterial=null;a._vkUpdateMaterialColor();a._vkUpdateMaterialOpacity();}}d.prototype._createOutlineGeometry=function(a){if(this._scene){this._scene._vkTraverseMeshNodes(function(b){if(b.isOutline){b.visible=true;}else{if(!b.hasOutline){var e;try{e=o(b);}catch(i){e=null;}if(e!==null){b.hasOutline=true;var j=new O(e);j.boundingBox=new THREE.Box3();var l=new THREE.LineSegments(j,this._outlineMaterial);l.isOutline=true;l.renderOrder=b.renderOrder+0.5;l.layers=b.layers;b.add(l);}}if(b.isMesh&&b.material&&!b.material.isLineBasicMaterial&&!b.material.isLineMaterial){switch(a){case R.LineIllustration:r(b,this._solidWhiteMaterial);break;case R.ShadedIllustration:var u=(b.userData.defaultMaterial||b.userData.originalMaterial||b.material).clone();if(u.emissive){u.color.multiplyScalar(0.5);u.emissive.multiplyScalar(0.5).addScalar(0.5);}else{u.color.multiplyScalar(0.5).addScalar(0.5);}r(b,u);break;default:t(b);break;}}}}.bind(this));}};d.prototype._hideOutlineGeometry=function(){if(this._scene){this._scene._vkTraverseMeshNodes(function(a){if(a.isOutline){a.visible=false;}if(a.isMesh){t(a);}});}};d.prototype.getInitialView=function(){return this._initialView;};d.prototype.setInitialView=function(v){this._initialView=v;};d.prototype.getMaterial=function(a){return this._materialMap.get(a);};d.prototype.setMaterial=function(a,b){this._materialMap.set(a,b);};d.prototype.clearMaterials=function(){this._materialMap.forEach(function(v,a){v.destroy();});this._materialMap.clear();};d.prototype._getNativeMaterial=function(a){var b=a?this._materialMap.get(a):null;return b?b.getMaterialRef():null;};d.prototype._setNodeMaterial=function(a,b){var e=this._getNativeMaterial(b);a.children.forEach(function(i){if(i.material){if(e){if(i.userData.materialId!==b){this._sceneBuilder._setSubmeshMaterial(i,e,b);}}else{var j=i.userData.initialMaterialId;if(j&&i.userData.materialId!==j){var l=this._getNativeMaterial(j);if(l){this._sceneBuilder._setSubmeshMaterial(i,l,j);}}}}}.bind(this));};d.prototype._allocateLayersChannel=function(){for(var a=0;a<32;a++){if((this._layersMask&(1<<a|0))===0){this._layersMask|=(1<<a|0);return a;}}return-1;};d.prototype._freeLayersChannel=function(a){this._layersMask&=~(1<<a|0);};return d;});
