sap.ui.define(["./TotaraUtils","./Command"],function(T,C){"use strict";function R(g){this.getBatchSize=g;this.globalList=new Set();this.requestedList=[];this.waitingList=new Set();}R.prototype.push=function(i,r){if(!this.globalList.has(i)){this.globalList.add(i);this.requestedList.push(r||i);this.waitingList.add(i);}};R.prototype.setBatchSizeInfo=function(b){this.batchSizeInfo=b;};R.prototype.fetchBatch=function(){var b=this.getBatchSize?this.getBatchSize:1;if(typeof this.getBatchSize==="function"){b=this.getBatchSize();}var a=0;var d=[];for(var i=0;i<b&&this.requestedList.length>0;i++){var e=this.requestedList.pop();a+=e.toString().length+(i==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);if(this.batchSizeInfo&&a>this.batchSizeInfo.maxBatchStringLength){this.requestedList.push(e);break;}d.push(e);}return d;};R.prototype.pop=function(i){return this.waitingList.delete(i);};R.prototype.isReady=function(i){return this.globalList.has(i)&&!this.waitingList.has(i);};R.prototype.clear=function(i){this.globalList.clear();this.requestedList=[];this.waitingList.clear();};R.prototype.isEmpty=function(){return this.requestedList.length===0;};R.prototype.isWaiting=function(){return this.waitingList.size>0;};function P(g,a){R.call(this,g);this.getMaxBatchDataSize=a;this.priorityMap=new Map();}P.prototype=Object.create(R.prototype);P.prototype.constructor=P;P.prototype.push=function(i,p,s){if(!this.globalList.has(i)){s=s||1;this.globalList.add(i);this.requestedList.push(i);this.waitingList.add(i);this.priorityMap.set(i,{p:p,s:s});}};P.prototype.clear=function(){R.prototype.clear.call(this);this.priorityMap.clear();};P.prototype.setBatchSizeInfo=function(b){this.batchSizeInfo=b;};P.prototype.fetchBatch=function(){var p=this.priorityMap;this.requestedList.sort(function(a,b){return p.get(a).p-p.get(b).p;});var d=[];var s=0;var e=this.getBatchSize?this.getBatchSize():1;var f=0;var m=this.getMaxBatchDataSize?this.getMaxBatchDataSize():1024*1024;var g=m>>1;for(var i=0;i<e&&this.requestedList.length>0;i++){var h=this.requestedList.pop();f+=h.toString().length+(i==0||!this.batchSizeInfo?0:this.batchSizeInfo.separatorLength);var r=p.get(h).s;if(this.batchSizeInfo&&f>this.batchSizeInfo.maxBatchStringLength||s>g&&s+r>m){this.requestedList.push(h);break;}s+=r;p.delete(h);d.push(h);}return d;};var c=function(a,s){this.context=a;this.sceneId=s;this.token=a.token||T.generateToken();var l=a.loader;this.meshes=new R(l.getMeshesBatchSize.bind(l));this.materials=new R(l.getMaterialsBatchSize.bind(l));this.textures=new R();this.geometries=new P(l.getGeometriesBatchSize.bind(l),l.getGeometriesMaxBatchDataSize.bind(l));this.geomMeshes=new P(l.getGeomMeshesBatchSize.bind(l),l.getGeomMeshesMaxBatchDataSize.bind(l));this.annotations=new R(l.getAnnotationsBatchSize.bind(l));this.parametric=new R(128);this.views=new R();this.thumbnails=new R();this.tracks=new R(l.getTracksBatchSize.bind(l));this.sequences=new R(l.getSequencesBatchSize.bind(l));this.highlights=new R();};c.prototype.isEmpty=function(){return this.meshes.isEmpty()&&this.annotations.isEmpty()&&this.parametric.isEmpty()&&this.materials.isEmpty()&&this.textures.isEmpty()&&this.geometries.isEmpty()&&this.geomMeshes.isEmpty()&&this.views.isEmpty()&&this.thumbnails.isEmpty()&&this.tracks.isEmpty()&&this.sequences.isEmpty()&&this.highlights.isEmpty();};c.prototype.isWaitingForContent=function(){return this.meshes.isWaiting()||this.textures.isWaiting()||this.materials.isWaiting()||this.geometries.isWaiting()||this.geomMeshes.isWaiting()||this.annotations.isWaiting()||this.parametric.isWaiting()||this.views.isWaiting()||this.thumbnails.isWaiting()||this.tracks.isWaiting()||this.sequences.isWaiting()||this.highlights.isWaiting();};c.prototype.clearContent=function(){this.meshes.clear();this.annotations.clear();this.parametric.clear();this.materials.clear();this.textures.clear();this.geometries.clear();this.geomMeshes.clear();this.views.clear();this.thumbnails.clear();this.tracks.clear();this.sequences.clear();this.highlights.clear();};c.prototype.createGetContentCommand=function(a,i,e){var o={sceneId:this.sceneId,ids:i.map(function(b){return parseInt(b,10);}),token:this.token};return T.createRequestCommand(a,e?Object.assign(o,e):o);};c.prototype.generateRequestCommand=function(){var i;var a=null;if(!this.meshes.isEmpty()){i=this.meshes.fetchBatch();a=this.createGetContentCommand(C.getMesh,i);}else if(!this.annotations.isEmpty()){i=this.annotations.fetchBatch();a=this.createGetContentCommand(C.getAnnotation,i);}else if(!this.parametric.isEmpty()){i=this.parametric.fetchBatch();a=this.createGetContentCommand(C.getParametric,i);}else if(!this.materials.isEmpty()){i=this.materials.fetchBatch();a=this.createGetContentCommand(C.getMaterial,i);}else if(!this.geometries.isEmpty()){i=this.geometries.fetchBatch();a=this.createGetContentCommand(C.getGeometry,i);a.sceneId=this.sceneId;a.geometryIds=i;}else if(!this.geomMeshes.isEmpty()){i=this.geomMeshes.fetchBatch();a=this.createGetContentCommand(C.getGeomMesh,i);a.sceneId=this.sceneId;a.meshIds=i;}else if(!this.textures.isEmpty()){i=this.textures.requestedList.splice(0,1);a=this.createGetContentCommand(C.getImage,[i[0].imageId]);a.sceneId=this.sceneId;a=Object.assign(a,i[0]);}else if(!this.sequences.isEmpty()){i=this.sequences.fetchBatch();a=this.createGetContentCommand(C.getSequence,i);}else if(!this.tracks.isEmpty()){i=this.tracks.fetchBatch();a=this.createGetContentCommand(C.getTrack,i);}else if(!this.views.isEmpty()){i=this.views.requestedList.splice(0,1);var e="nodes,bounds,animation";var b=this.context.includeAnimation!==undefined?this.context.includeAnimation:true;if(!b){e="nodes,bounds";}var s="name,transform,meshId,annotationId,materialId,contentType,visible,opacity,renderOrder,entityId,highlightStyleId";a=T.createRequestCommand(C.getView,{sceneId:this.sceneId,groupId:i[0].viewGroupId,id:i[0].viewId,includeHidden:this.context.includeHidden!==undefined?this.context.includeHidden:true,includeBackground:this.context.includeBackground!==undefined?this.context.includeBackground:true,includeParametric:this.context.includeParametric!==undefined?this.context.includeParametric:true,$expand:e,$select:s,token:this.token});}else if(!this.highlights.isEmpty()){i=this.highlights.requestedList.splice(0,1);a=T.createRequestCommand(C.getHighlightStyle,{sceneId:this.sceneId,id:i[0],token:this.token});}else if(!this.thumbnails.isEmpty()){i=this.thumbnails.requestedList.splice(0,1);a=this.createGetContentCommand(C.getImage,[i[0].imageId]);a.sceneId=this.sceneId;a=Object.assign(a,i[0]);}return a;};return c;});
