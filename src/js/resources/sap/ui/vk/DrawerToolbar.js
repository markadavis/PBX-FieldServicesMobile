/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)

        (c) Copyright 2009-2015 SAP SE. All rights reserved
    
 */
sap.ui.define(["./library","./DrawerToolbarRenderer","sap/ui/core/Control","sap/m/VBox","sap/m/FlexItemData","sap/m/OverflowToolbar","sap/ui/core/Icon","sap/m/Button","sap/m/ToolbarSeparator","sap/m/ToggleButton","sap/m/MenuButton","./tools/Tool","./tools/RectSelectTool","./tools/CrossSectionTool","sap/m/Menu","sap/m/MenuItem","./ZoomTo","./getResourceBundle","./Viewport","./DrawerToolbarButton","sap/ui/base/ManagedObjectObserver"],function(v,D,C,V,F,O,I,B,T,a,M,b,R,c,d,e,Z,g,f,h,j){"use strict";var k=C.extend("sap.ui.vk.DrawerToolbar",{metadata:{properties:{expanded:{type:"boolean",defaultValue:true}},aggregations:{content:{type:"sap.ui.core.Control",multiple:true,forwarding:{getter:"_getToolbar",aggregation:"content",forwardBinding:true}}},associations:{viewport:{type:"sap.ui.vk.Viewport",multiple:false}},events:{expanded:{parameters:{expand:{type:"boolean"}}}}},constructor:function(i,S){C.apply(this,arguments);}});var l=[{name:"show",unicode:"e000"},{name:"hide",unicode:"e001"},{name:"turntable",unicode:"e002"},{name:"orbit",unicode:"e003"},{name:"pan",unicode:"e004"},{name:"zoom",unicode:"e005"},{name:"fit-to-view",unicode:"e006"},{name:"rectangular-selection",unicode:"e007"},{name:"structure-browser",unicode:"e008"},{name:"configuration",unicode:"e009"},{name:"setting",unicode:"e00a"},{name:"full-screen",unicode:"e00b"},{name:"predefined-views",unicode:"e00c"},{name:"authoring-app",unicode:"e00d"},{name:"dot",unicode:"e00e"},{name:"empty",unicode:"e00f"},{name:"right-panel-menu",unicode:"e010"},{name:"viewer-app",unicode:"e011"},{name:"hide-association",unicode:"e012"},{name:"cross-section",unicode:"e013"},{name:"cross-section-x",unicode:"e014"},{name:"cross-section-z",unicode:"e015"},{name:"cross-section-y",unicode:"e016"},{name:"reverse-direction",unicode:"e017"},{name:"create-editable-visualisation",unicode:"e018"},{name:"cross-section-z-",unicode:"e019"}],m="vk-icons",n="vk-icons";l.forEach(function(i){sap.ui.core.IconPool.addIcon(i.name,m,n,i.unicode);});var o="sap-icon://vk-icons/";k.prototype.init=function(){if(C.prototype.init){C.prototype.init.apply(this);}this._itemsVisibility=new Map();this._itemsVisibilityObserver=new j(this._itemVisibilityChanged.bind(this));this._toolbar=new O({width:"auto",design:sap.m.ToolbarDesign.Solid,layoutData:new F({growFactor:0,shrinkFactor:0}),content:this.createButtons()});this._toolbar.ontouchstart=function(i){i.setMarked();};this._toolbarObserver=new j(this._toolbarContentChanged.bind(this));this._toolbarObserver.observe(this._toolbar,{aggregations:["content"]});this._container=new V({renderType:sap.m.FlexRendertype.Bare,alignContent:sap.m.FlexAlignContent.Center,alignItems:sap.m.FlexAlignItems.Center,items:[this._toolbar,new I({src:"sap-icon://navigation-up-arrow",noTabStop:true,press:function(i){this._toggleExpanded();}.bind(this),layoutData:new F({growFactor:0,shrinkFactor:0})}).addStyleClass("drawerToolbarIcon")]});this._rectSelectTool=new R();};k.prototype._toolbarContentChanged=function(){var p=this._toolbar.getContent();for(var i=0;i<p.length;i++){if(p[i].getMetadata().getName()=="sap.m.ToolbarSeparator"){if(p[i-1]==undefined||p[i+1]==undefined||p[i-1].getMetadata().getName()=="sap.m.ToolbarSeparator"){this._toolbar.removeContent(i);}}}};k.prototype._itemVisibilityChanged=function(i){if(!this._ignoreVisiblityChange){this._itemsVisibility.set(i.object,i.current);}};k.prototype._getViewport=function(){var i=sap.ui.getCore().byId(this.getViewport());if(i.getMetadata().getName()==="sap.ui.vk.threejs.Viewport"||i.getMetadata().getName()==="sap.ui.vk.svg.Viewport"){return i;}if(i instanceof f&&i.getImplementation()&&(i.getImplementation().getMetadata().getName()==="sap.ui.vk.threejs.Viewport"||i.getImplementation().getMetadata().getName()==="sap.ui.vk.svg.Viewport")){return i.getImplementation();}return null;};k.prototype._getViewStateManager=function(){var i=sap.ui.getCore().byId(this.getViewport());var p=i.getViewStateManager();if(p){return sap.ui.getCore().byId(p);}return null;};var q=[null,new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),0),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),-Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(0,1,0),Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),-Math.PI/2),new THREE.Quaternion().setFromAxisAngle(new THREE.Vector3(1,0,0),Math.PI/2)];k.prototype.createButtons=function(){var i=this;var p,y;function z(W,X,Y){p.setPressed(true);if(i._crossSectionTool){i._crossSectionTool.setActive(true,W);if(X!==undefined){i._crossSectionTool.setAxis(X);y.setIcon(o+"cross-section-"+["x","y","z"][X]);}}}p=new a({icon:o+"cross-section",type:sap.m.ButtonType.Transparent,tooltip:"Cross Section",press:function(W){var X=i._getViewport();if(X){if(this.getPressed()){z(X);}else if(i._crossSectionTool){i._crossSectionTool.setActive(false,X);}}}});p.vitId=h.CrossSection;y=new M({type:sap.m.ButtonType.Transparent,tooltip:"Cross Section Axis",icon:o+"cross-section-x",menu:new d({items:[new e({icon:o+"cross-section-x",text:g().getText("CROSS_SECTION_X"),press:function(W){var X=i._getViewport();if(X){z(X,0,false);}}}),new e({icon:o+"cross-section-y",text:g().getText("CROSS_SECTION_Y"),press:function(W){var X=i._getViewport();if(X){z(X,1,false);}}}),new e({icon:o+"cross-section-z",text:g().getText("CROSS_SECTION_Z"),press:function(W){var X=i._getViewport();if(X){z(X,2,false);}}}),new e({icon:o+"reverse-direction",text:g().getText("CROSS_SECTION_REVERSE"),startsSection:true,press:function(W){var X=i._getViewport();if(X&&i._crossSectionTool&&i._crossSectionTool.getActive()){i._crossSectionTool.setFlip(!i._crossSectionTool.getFlip());}}})]})});y.vitId=h.CrossSectionAxis;var A=new a({icon:o+"turntable",type:sap.m.ButtonType.Transparent,tooltip:"Turntable",press:function(W){var X=i._getViewport();if(X){i._activateGesture(X,0);}}});A.vitId=h.Turntable;var E=new a({icon:o+"orbit",type:sap.m.ButtonType.Transparent,tooltip:"Orbit",pressed:false,press:function(W){var X=i._getViewport();if(X){i._activateGesture(X,1);}}});E.vitId=h.Orbit;var G=new a({icon:o+"pan",type:sap.m.ButtonType.Transparent,tooltip:"Pan",press:function(W){var X=i._getViewport();if(X){i._activateGesture(X,2);}}});G.vitId=h.Pan;var H=new a({icon:o+"zoom",type:sap.m.ButtonType.Transparent,tooltip:"Zoom",press:function(){var W=i._getViewport();if(W){i._activateGesture(W,3);}}});H.vitId=h.Zoom;this._activeGesture=-1;this._gestureButtons=[A,E,G,H];var J=new B({icon:o+"show",type:sap.m.ButtonType.Transparent,tooltip:"Show",press:function(){var W=i._getViewStateManager();if(W){var X=[];W.enumerateSelection(function(Y){X.push(Y);});W.setVisibilityState(X,true,true);}}});J.vitId=h.Show;var K=new B({icon:o+"hide",type:sap.m.ButtonType.Transparent,tooltip:"Hide",press:function(){var W=i._getViewStateManager();if(W){var X=[];W.enumerateSelection(function(Y){X.push(Y);});W.setVisibilityState(X,false,true);}}});K.vitId=h.Hide;var L=new B({icon:o+"fit-to-view",type:sap.m.ButtonType.Transparent,tooltip:g().getText("FIT_TO_VIEW"),press:function(){var W=sap.ui.getCore().byId(i.getViewport());if(W){W.zoomTo(Z.All,null,0.5,0);}}});L.vitId=h.FitToView;this._rectSelectionButton=new a({icon:o+"rectangular-selection",type:sap.m.ButtonType.Transparent,tooltip:"Rectangular Selection"});this._rectSelectionButton.vitId=h.RectangularSelection;var N=new M({icon:o+"predefined-views",activeIcon:o+"predefined-views",type:sap.m.ButtonType.Transparent,tooltip:g().getText("PREDEFINED_VIEW_MENUBUTTONTOOLTIP"),menu:new d({items:[new e({text:g().getText("PREDEFINED_VIEW_INITIAL")}),new e({text:g().getText("PREDEFINED_VIEW_FRONT"),startsSection:true}),new e({text:g().getText("PREDEFINED_VIEW_BACK")}),new e({text:g().getText("PREDEFINED_VIEW_LEFT")}),new e({text:g().getText("PREDEFINED_VIEW_RIGHT")}),new e({text:g().getText("PREDEFINED_VIEW_TOP")}),new e({text:g().getText("PREDEFINED_VIEW_BOTTOM")})]}).attachItemSelected(function(W){var X=i._getViewport();if(X){var Y=W.getParameters("item").item;var $=this.indexOfItem(Y);X._viewportGestureHandler.setView(q[$],1000);}})});N.vitId=h.PredefinedViews;var P=new a({icon:o+"full-screen",type:sap.m.ButtonType.Transparent,tooltip:g().getText("VIEWER_FULLSCREENBUTTONTOOLTIP"),press:function(W){var X=i._getViewport();var Y=function(_){return!!(_.fullScreen||_.webkitIsFullScreen||_.mozFullScreen||_.msFullscreenElement);};if(this.getPressed()){if(!Y(document)){if(!i._fullScreenHandler){i._fullScreenHandler=function(W){var _=Y(document);if(!_){document.removeEventListener("fullscreenchange",i._fullScreenHandler);document.removeEventListener("mozfullscreenchange",i._fullScreenHandler);document.removeEventListener("webkitfullscreenchange",i._fullScreenHandler);document.removeEventListener("MSFullscreenChange",i._fullScreenHandler);this.setPressed(false);X.removeStyleClass("sapVizKitViewerFullScreen");}}.bind(this);}var $=document.getElementsByTagName("body")[0];if($.requestFullscreen){document.addEventListener("fullscreenchange",i._fullScreenHandler);$.requestFullscreen();}else if($.webkitRequestFullScreen){document.addEventListener("webkitfullscreenchange",i._fullScreenHandler);$.webkitRequestFullscreen();}else if($.mozRequestFullScreen){document.addEventListener("mozfullscreenchange",i._fullScreenHandler);$.mozRequestFullScreen();}else if($.msRequestFullscreen){document.addEventListener("MSFullscreenChange",i._fullScreenHandler);$.msRequestFullscreen();}}X.addStyleClass("sapVizKitViewerFullScreen");}else{if(Y(document)){if(document.cancelFullScreen){document.cancelFullScreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}else if(document.mozCancelFullScreen){document.mozCancelFullScreen();}else if(document.webkitCancelFullScreen){document.webkitCancelFullScreen();}}X.removeStyleClass("sapVizKitViewerFullScreen");}}});P.vitId=h.FullScreen;var Q=new T();var S=new T();this._items3D=[this._gestureButtons[0],this._gestureButtons[1],p,y,Q,N,S];var U=[J,K,new T(),this._gestureButtons[0],this._gestureButtons[1],this._gestureButtons[2],this._gestureButtons[3],new T(),L,new T(),this._rectSelectionButton,new T(),p,y,Q,N,S,P];U.forEach(function(W){this._itemsVisibility.set(W,true);this._itemsVisibilityObserver.observe(W,{properties:["visible"]});}.bind(this));return U;};var r=["drawerToolbarIconTurntable","drawerToolbarIconOrbit","drawerToolbarIconPan","drawerToolbarIconZoom"];var s=["drawerToolbarIconTurntable360","drawerToolbarIconOrbit360","drawerToolbarIconPan360","drawerToolbarIconZoom360"];var t=function(i,p){this.viewport=i;this._toolbar=p;this._mode=1;this._gesture=false;this._x=0;this._y=0;};function u(p,y){var z=p._isPanoramicActivated()?s:r;z.forEach(function(A,i){if(p.hasStyleClass(A)&&i!==y){p.removeStyleClass(A);}else if(i===y){p.addStyleClass(A);}});}function w(i){var p=i.viewport;var y=i._mode;var z=p.hasStyleClass(r[y])?y:-1;i._isScrolling=true;if(z!==3){u(p,3);setTimeout(function(){i._isScrolling=false;u(p,z);},500);}}function x(i){return i?i.getMetadata().getName()==="sap.ui.vk.threejs.Viewport":false;}t.prototype.beginGesture=function(i){this._gesture=true;if(this._mode<3){this._x=i.points[0].x;this._y=i.points[0].y;}else{this._x=i.x;this._y=i.y;}if(i.scroll){w(this);}if(this._toolbar._rectSelectionButton.getPressed()||(i.event&&(sap.ui.Device.os.macintosh?i.event.metaKey:i.event.ctrlKey))){var p=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect={x1:this._x-p.left,y1:this._y-p.top,x2:this._x-p.left,y2:this._y-p.top};}};t.prototype.endGesture=function(){this._gesture=false;if(this._selectionRect&&(this._selectionRect.x1!==this._selectionRect.x2||this._selectionRect.y1!==this._selectionRect.y2)){if(x(this.viewport)){this._toolbar._rectSelectTool._select(this._selectionRect.x1,this._selectionRect.y1,this._selectionRect.x2,this._selectionRect.y2,this.viewport,this.viewport.getScene(),this.viewport.getCamera());}else{this.viewport._select(this._selectionRect);}this._selectionRect=null;this.viewport.setSelectionRect(null);}else if(!this._isScrolling){u(this.viewport,-1);}};t.prototype.move=function(i){if(this._gesture&&i.n==1){var p=i.points[0];if(this._selectionRect){var y=this.viewport.getDomRef().getBoundingClientRect();this._selectionRect.x2=p.x-y.left;this._selectionRect.y2=p.y-y.top;this.viewport.setSelectionRect(this._selectionRect);}else{u(this.viewport,this._mode);var z=p.x-this._x;var A=p.y-this._y;var E=x(this.viewport)?this.viewport._viewportGestureHandler._cameraController:this.viewport;switch(this._mode){case 0:E.rotate(z,A,true);break;case 1:E.rotate(z,A,false);break;case 2:E.pan(z,A);break;case 3:E.zoom(1+A*0.005);break;default:break;}this._x=p.x;this._y=p.y;}i.handled=true;}};t.prototype.hover=function(){};t.prototype.getViewport=function(){return this.viewport;};k.prototype._activateGesture=function(i,p){this._activeGesture=p;this._gestureButtons.forEach(function(y,z){y.setPressed(z===p);});if(!this._cameraHandler||this._cameraHandler.getViewport()!=i){this._cameraHandler=new t(i,this);i._loco.addHandler(this._cameraHandler,0);}this._cameraHandler._mode=p;};k.prototype._getToolbar=function(){return this._toolbar;};k.prototype._toggleExpanded=function(){var i=!this.getExpanded();this.setExpanded(i);this.fireExpanded({expand:i});};k.prototype.setExpanded=function(E){this.setProperty("expanded",E,true);var i=this.getDomRef();if(i){if(!E){i.classList.add("drawerToolbarCollapsed");i.classList.remove("drawerToolbarExpanded");this._container.addStyleClass("vboxCollapsed");}else{i.classList.add("drawerToolbarExpanded");i.classList.remove("drawerToolbarCollapsed");this._container.removeStyleClass("vboxCollapsed");}}return this;};k.prototype.onBeforeRendering=function(){var i=this._getViewport();if(i){var p=x(i);this._ignoreVisiblityChange=true;this._items3D.forEach(function(y){y.setVisible(p&&this._itemsVisibility.get(y));}.bind(this));this._ignoreVisiblityChange=false;if(p){this._crossSectionTool=this._crossSectionTool||new c();i.addTool(this._crossSectionTool);}if(!p&&this._activeGesture<2){this._activateGesture(i,2);}else if(this._activeGesture<0){this._activateGesture(i,0);}}};return k;});
