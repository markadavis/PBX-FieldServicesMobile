/*
 * ! SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['sap/m/P13nConditionPanel','sap/m/library','sap/ui/core/library','sap/ui/core/Control','sap/ui/core/IconPool','sap/ui/Device','sap/ui/core/InvisibleText','sap/ui/core/ResizeHandler','sap/ui/core/Item','sap/ui/core/ListItem','sap/ui/model/odata/type/Boolean','sap/ui/model/type/String','sap/ui/model/odata/type/String','sap/ui/model/type/Date','sap/ui/model/type/Time','sap/ui/model/odata/type/DateTime','sap/ui/model/type/Float','sap/m/Button','sap/m/OverflowToolbar','sap/m/OverflowToolbarLayoutData','sap/m/ToolbarSpacer','sap/m/Text','sap/m/SearchField','sap/m/CheckBox','sap/m/ComboBox','sap/m/Select','sap/m/Label','sap/m/Input','sap/m/DatePicker','sap/m/TimePicker','sap/m/DateTimePicker','sap/base/Log','sap/ui/thirdparty/jquery','sap/ui/comp/valuehelpdialog/P13nOperationsHelper','sap/m/P13nConditionPanelRenderer'],function(P,l,c,C,I,D,a,R,b,L,B,S,d,e,T,f,F,g,O,h,k,m,o,p,q,r,s,t,u,v,w,x,Q,y,z){"use strict";var G,A,E=l.ButtonType,H=l.P13nConditionOperation,J=l.P13nConditionOperationType;var K=P.extend("sap.ui.comp.valuehelpdialog.P13nConditionPanel",{metadata:{library:"sap.ui.comp.valuehelpdialog"},renderer:z.renderer});K.prototype.init=function(){P.prototype.init.apply(this);this._oOperationsHelper=new y();};K.prototype.setOperations=function(i,j,n){var M=n?J.Exclude:J.Include;j=j||"default";if(this._oTypeOperations[j]===undefined){this._oTypeOperations[j]={};}this._oTypeOperations[j][M]=i;this._updateAllOperations();};K.prototype.setValues=function(V,i){i=i||"default";this._oTypeValues[i]=V;};K.prototype.addOperation=function(i,j,n){var M=n?J.Exclude:J.Include;j=j||"default";if(this._oTypeOperations[j]===undefined){this._oTypeOperations[j]={};}if(this._oTypeOperations[j][M]===undefined){this._oTypeOperations[j][M]=[];}this._oTypeOperations[j][M].push(i);this._updateAllOperations();};K.prototype.getOperations=function(i,j){var n,M,N,U;i=i||"default";if(j!==undefined){n=j?J.Exclude:J.Include;U=this._oTypeOperations[i]&&this._oTypeOperations[i][n]||[];}else{M=this._oTypeOperations[i]&&this._oTypeOperations[i][J.Include]||[];N=this._oTypeOperations[i]&&this._oTypeOperations[i][J.Exclude]||[];U=M.concat(N);}return U;};K.prototype._updatePaginatorToolbar=function(){if(this._sConditionType!=="Filter"||this.getMaxConditions()!=="-1"){return;}var i=this._aConditionKeys.length;var j=1+Math.floor(Math.max(0,i-1)/this._iConditionPageSize);var n=1+Math.floor(this._iFirstConditionIndex/this._iConditionPageSize);var M=this.getParent();if(!this._oPaginatorToolbar){if(i>this._iConditionPageSize){this._createPaginatorToolbar();this.insertAggregation("content",this._oPaginatorToolbar,0);this._onGridResize();}else{if(M&&M.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=M.getHeaderText();}}return;}}this._oPrevButton.setEnabled(this._iFirstConditionIndex>0);this._oNextButton.setEnabled(this._iFirstConditionIndex+this._iConditionPageSize<i);if(M&&M.setHeaderToolbar){if(!M.getHeaderToolbar()){this.removeAggregation("content",this._oPaginatorToolbar);M.setHeaderToolbar(this._oPaginatorToolbar);M.attachExpand(function(V){this._setToolbarElementVisibility(V.getSource().getExpanded()&&this._bPaginatorButtonsVisible);}.bind(this));}}if(M&&M.getMetadata().getName()==="sap.m.Panel"){if(this._sOrgHeaderText==undefined){this._sOrgHeaderText=M.getHeaderText();}var N=this._sOrgHeaderText+(i>0?" ("+i+")":"");this._oHeaderText.setText(N);}else{this._oHeaderText.setText(i+" Conditions");}this._oPageText.setText(n+"/"+j);this._bPaginatorButtonsVisible=this._bPaginatorButtonsVisible||j>1;this._setToolbarElementVisibility(this._bPaginatorButtonsVisible);if(n>j){this._iFirstConditionIndex-=Math.max(0,this._iConditionPageSize);this._clearConditions();this._fillConditions();}var U=0;this._oConditionsGrid.getContent().forEach(function(V){if(V.select.getSelected()){U++;}},this);if(j==n&&(i-this._iFirstConditionIndex)>U){this._clearConditions();this._fillConditions();}};K.prototype._setToolbarElementVisibility=function(V){this._oPrevButton.setVisible(V);this._oNextButton.setVisible(V);this._oPageText.setVisible(V);this._oFilterField.setVisible(false);this._setLayoutVisible(this._oAddButton,V);this._setLayoutVisible(this._oRemoveAllButton,V);};K.prototype._unregisterResizeHandler=function(){if(this._sContainerResizeListener){R.deregister(this._sContainerResizeListener);this._sContainerResizeListener=null;}};K.prototype._registerResizeHandler=function(){if(this.getContainerQuery()){this._sContainerResizeListener=R.register(this._oConditionsGrid,this._onGridResize.bind(this));this._onGridResize();}};K.prototype._handleRemoveCondition=function(i,j){var n=i.getContent().indexOf(j);this._removeCondition(i,j);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(i,false);}if(n>=0){n=Math.min(n,i.getContent().length-1);var j=i.getContent()[n];setTimeout(function(){j.remove.focus();});}this._updatePaginatorToolbar();};K.prototype._getCurrentKeyFieldItem=function(i){if(i.getSelectedKey&&i.getSelectedKey()){var j=i.getSelectedKey();var n=this._aKeyFields;for(var M in n){var N=n[M];if(N.key===j){return N;}}}return null;};K.prototype._createConditionRow=function(i,j,n,M,U){var N,V=this,G=K._getGridConstructor(),A=K._getGridDataConstructor();if(M===undefined){M=i.getContent().length;}var W=new G({width:"100%",defaultSpan:"L12 M12 S12",hSpacing:1,vSpacing:0,containerQuery:this.getContainerQuery()}).data("_key",n);for(var X in this._aConditionsFields){var Y;var Z=this._aConditionsFields[X];switch(Z["Control"]){case"CheckBox":Y=new p({enabled:false,layoutData:new A({span:Z["Span"+this._sConditionType]})});this._setLayoutVisible(Y,false);if(Z["ID"]==="showIfGrouped"){Y.setEnabled(true);Y.setText(Z["Label"]);Y.attachSelect(function(){V._changeField(W);});Y.setSelected(j?j.showIfGrouped:true);}else{if(j){Y.setSelected(true);Y.setEnabled(true);}}break;case"ComboBox":if(Z["ID"]==="keyField"){Y=new q({width:"100%",ariaLabelledBy:this._oInvisibleTextField});var $=Y.setSelectedKey.bind(Y);Y.setSelectedKey=function(n){$(n);var k1=V.getValidationExecutor();if(k1){k1();}};var _=Y.setSelectedItem.bind(Y);Y.setSelectedItem=function(k1){_(k1);var l1=V.getValidationExecutor();if(l1){l1();}};Y.setLayoutData(new A({span:Z["Span"+this._sConditionType]}));this._fillKeyFieldListItems(Y,this._aKeyFields);if(Y.attachSelectionChange){Y.attachSelectionChange(function(k1){var l1=V.getValidationExecutor();if(l1){l1();}V._handleSelectionChangeOnKeyField(i,W);});}if(Y.attachChange){Y.attachChange(function(k1){W.keyField.close();V._handleChangeOnKeyField(i,W);});}if(Y.setSelectedItem){if(j){Y.setSelectedKey(j.keyField);this._aKeyFields.forEach(function(a1,k1){var l1=a1.key;if(l1===undefined){l1=a1;}if(j.keyField===l1){Y.setSelectedItem(Y.getItems()[k1]);}},this);}else{if(this.getUsePrevConditionSetting()&&!this.getAutoReduceKeyFieldItems()){if(M>0&&!n&&U){N=i.getContent()[M-1];if(N.keyField.getSelectedKey()){Y.setSelectedKey(N.keyField.getSelectedKey());}else{if(!Y.getSelectedItem()&&Y.getItems().length>0){Y.setSelectedItem(Y.getItems()[0]);}}}else{this._aKeyFields.some(function(a1,k1){if(a1.isDefault){Y.setSelectedItem(Y.getItems()[k1]);return true;}if(!Y.getSelectedItem()&&a1.type!=="boolean"){Y.setSelectedItem(Y.getItems()[k1]);}},this);if(!Y.getSelectedItem()&&Y.getItems().length>0){Y.setSelectedItem(Y.getItems()[0]);}}}else{this._aKeyFields.forEach(function(a1,k1){if(a1.isDefault){Y.setSelectedItem(Y.getItems()[k1]);}},this);}}}}if(Z["ID"]==="operation"){Y=new r({width:"100%",ariaLabelledBy:this._oInvisibleTextOperator,layoutData:new A({span:Z["Span"+this._sConditionType]})});Y.attachChange(function(){V._handleChangeOnOperationField(i,W);});W[Z["ID"]]=Y;this._updateOperationItems(i,W);if(j){var a1=this._getCurrentKeyFieldItem(W.keyField),b1=this._getRelevantOperations(a1),c1=this.getCurrentOparation(j);b1.some(function(k1){if(c1===k1){Y.setSelectedKey(k1);return true;}},this);}else{if(this.getUsePrevConditionSetting()){if(M>0&&n===null){var N=i.getContent()[M-1];Y.setSelectedKey(N.operation.getSelectedKey());}}}}if(Y.getSelectedItem&&Y.getSelectedItem()&&Y.getMetadata()._sUIDToken!=="box"){Y.setTooltip(Y.getSelectedItem().getTooltip()||Y.getSelectedItem().getText());}break;case"TextField":var d1=this._getCurrentKeyFieldItem(W.keyField);Y=this._createValueField(d1,Z,W);Y.oTargetGrid=i;if(j&&j[Z["ID"]]!==undefined){var e1=j[Z["ID"]];if(Y instanceof r){if(typeof e1==="boolean"){Y.setSelectedIndex(e1?2:1);}}else if(e1!==null&&W.oType){if(typeof e1==="string"&&W.oType.getName()==="sap.ui.comp.odata.type.StringDate"){Y.setValue(e1);}else{if(typeof e1==="string"&&["String","sap.ui.model.odata.type.String","sap.ui.model.odata.type.Decimal"].indexOf(W.oType.getName())==-1){try{e1=W.oType.parseValue(e1,"string");Y.setValue(W.oType.formatValue(e1,"string"));}catch(f1){x.error("sap.m.P13nConditionPanel","Value '"+e1+"' does not have the expected type format for "+W.oType.getName()+".parseValue()");}}else{Y.setValue(W.oType.formatValue(e1,"string"));}}}else{Y.setValue(e1);}}break;case"Label":Y=new s({text:Z["Text"]+":",visible:this.getShowLabel(),layoutData:new A({span:Z["Span"+this._sConditionType]})}).addStyleClass("conditionLabel");Y.oTargetGrid=i;break;}W[Z["ID"]]=Y;W.addContent(Y);}this._addButtons(W,i);i.insertContent(W,M);this._updateOperationItems(i,W);this._changeOperationValueFields(i,W);this._updateAllConditionsEnableStates();this._updateConditionButtons(i);if(this.getAutoReduceKeyFieldItems()){this._updateKeyFieldItems(i,false);}if(this._sLayoutMode){this._updateLayout({name:this._sLayoutMode});}if(j){var g1=this._getFormatedConditionText(j.operation,j.value1,j.value2,j.exclude,j.keyField,j.showIfGrouped);j._oGrid=W;j.value=g1;this._oConditionsMap[n]=j;}var h1=W.operation.getSelectedKey();if(h1==="BT"&&W.value1.setMinDate&&W.value2.setMaxDate){var i1=W.value1.getDateValue();var j1=W.value2.getDateValue();this._updateMinMaxDate(W,i1,j1);}else{this._updateMinMaxDate(W,null,null);}return W;};K.prototype._fillOperationListItems=function(i,j,n){if(n==="_STRING_"){n="";}if(n==="_TIME_"||n==="_DATETIME_"){n="_DATE_";}if(n==="_BOOLEAN_"||n==="_NUMC_"){n="";}i.destroyItems();j.forEach(function(M){var N=this._oRb.getText("CONDITIONPANEL_OPTION"+n+M);if(N.startsWith("CONDITIONPANEL_OPTION")){N=this._oRb.getText("CONDITIONPANEL_OPTION"+M);}i.setShowSecondaryValues(true);i.addItem(new L({key:M,text:N,additionalText:this._oOperationsHelper.isExcludeType(M)?J.Exclude:J.Include,tooltip:N}));}.bind(this));};K.prototype._fillKeyFieldListItems=function(i,j){i.destroyItems();for(var n in j){var M=j[n];i.addItem(new L({key:M.key,text:M.text,tooltip:M.tooltip?M.tooltip:M.text}));}this._setLayoutVisible(i,i.getItems().length>1);};K.prototype._updateKeyFieldItems=function(M,N,U,V){var n=M.getContent().length;var i;var W={};if(!N){for(i=0;i<n;i++){var X=M.getContent()[i].keyField;var Y=X.getSelectedKey();if(Y!=null&&Y!==""){W[Y]=true;}}}for(i=0;i<n;i++){var X=M.getContent()[i].keyField;var Z=M.getContent()[i].select;var $=X.getSelectedKey();var j=0;var _=this._aKeyFields;if(X!==V){if(U){j=_.length-1;}else{X.destroyItems();}for(j;j<_.length;j++){var a1=_[j];if(a1.key==null||a1.key===""||!W[a1.key]||a1.key===$){X.addItem(new L({key:a1.key,text:a1.text,tooltip:a1.tooltip?a1.tooltip:a1.text}));}}this._setLayoutVisible(X,X.getItems().length>1);}if($){X.setSelectedKey($);}else if(X.getItems().length>0){X.setSelectedItem(X.getItems()[0]);}if(!Z.getSelected()){this._aKeyFields.some(function(b1,c1){if(b1.isDefault){X.setSelectedItem(X.getItems()[c1]);return true;}if(!X.getSelectedItem()){if(b1.type!=="boolean"){X.setSelectedItem(X.getItems()[c1]);}}},this);}if(X.getSelectedItem()){X.setTooltip(X.getSelectedItem().getTooltip()||X.getSelectedItem().getText());}}};K.prototype._adjustValue1Span=function(i){if(this._sConditionType==="Filter"&&i.value1&&i.operation){var j=i.operation;var n=this._aConditionsFields[5]["Span"+this._sConditionType];var M=j.getSelectedKey();if(M!==H.BT&&M!==H.NotBT){n=this._aKeyFields.length>1?"L5 M10 S10":"XL8 L8 M8 S10";}var N=i.value1.getLayoutData();if(N.getSpan()!==n){N.setSpan(n);}}};K.prototype._changeField=function(i,j){var n=i.keyField.getSelectedKey();if(i.keyField.getSelectedItem()){i.keyField.setTooltip(i.keyField.getSelectedItem().getTooltip()||i.keyField.getSelectedItem().getText());}else{i.keyField.setTooltip(null);}var M=i.operation.getSelectedKey();var N=this._oOperationsHelper.isExcludeType(M);M=N?this._oOperationsHelper.getCorrespondingIncludeOperation(M):M;if(i.operation.getSelectedItem()){i.operation.setTooltip(i.operation.getSelectedItem().getTooltip()||i.operation.getSelectedItem().getText());}else{i.operation.setTooltip(null);}var U=function(g1,h1){var b1;var i1;if(g1.getDateValue&&!(g1.isA("sap.m.TimePicker"))&&h1.getName()!=="sap.ui.comp.odata.type.StringDate"){i1=g1.getDateValue();if(h1&&i1){if((j&&j.getParameter("valid"))||g1.isValidValue()){b1=h1.formatValue(i1,"string");}else{b1="";}}}else{b1=this._getValueTextFromField(g1);i1=b1;if(h1&&h1.getName()==="sap.ui.comp.odata.type.StringDate"){b1=h1.formatValue(i1,"string");}else if(h1&&b1){try{i1=h1.parseValue(b1,"string");h1.validateValue(i1);}catch(j1){x.error("sap.m.P13nConditionPanel","not able to parse value "+b1+" with type "+h1.getName());b1="";}}}return[i1,b1];}.bind(this);var V=U(i.value1,i.oType);var W=V[0],X=V[1];V=U(i.value2,i.oType);var Y=V[0],Z=V[1];if(this._hasSecondValue(M)){this._updateMinMaxDate(i,W,Y);}else{this._updateMinMaxDate(i,null,null);}var $=this._getCurrentKeyFieldItem(i.keyField);if($&&$.type==="numc"){if([H.Contains,H.EndsWith].indexOf(M)!=-1){W=i.oType.formatValue(W,"string");}}var _=i.showIfGrouped.getSelected();var a1=i.select;var b1="";var c1;if(n===""||n==null){n=null;c1=this._getKeyFromConditionGrid(i);this._removeConditionFromMap(c1);this._enableCondition(i,false);var d1=this._getIndexOfCondition(i);if(a1.getSelected()){a1.setSelected(false);a1.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:c1,index:d1,operation:"remove",newData:null});this._bIgnoreSetConditions=false;}return;}this._enableCondition(i,true);b1=this._getFormatedConditionText(M,X,Z,N,n,_);var e1={"value":b1,"exclude":N,"operation":M,"keyField":n,"value1":W,"value2":this._hasSecondValue(M)?Y:null,"showIfGrouped":_};c1=this._getKeyFromConditionGrid(i);if(b1!==""){a1.setSelected(true);a1.setEnabled(true);var f1="update";if(!this._oConditionsMap[c1]){f1="add";}this._oConditionsMap[c1]=e1;if(f1==="add"){this._aConditionKeys.splice(this._getIndexOfCondition(i),0,c1);}i.data("_key",c1);this.fireDataChange({key:c1,index:this._getIndexOfCondition(i),operation:f1,newData:e1});}else if(this._oConditionsMap[c1]!==undefined){this._removeConditionFromMap(c1);i.data("_key",null);var d1=this._getIndexOfCondition(i);if(a1.getSelected()){a1.setSelected(false);a1.setEnabled(false);this._bIgnoreSetConditions=true;this.fireDataChange({key:c1,index:d1,operation:"remove",newData:null});this._bIgnoreSetConditions=false;}}this._updatePaginatorToolbar();};K.prototype._getConditions=function(i){return{"index":this._iConditions,"key":this._createConditionKey(),"exclude":this._oOperationsHelper.isExcludeType(i.oOperation),"operation":i.oOperation,"keyField":i.oKeyField,"value1":i.oPastedValue,"value2":null};};K.prototype._changeOperationValueFields=function(i,j){P.prototype._changeOperationValueFields.apply(this,arguments);var n=j.getContent().length,M=j.remove,N=j.indexOfContent(M),U=n-1;if(N!==U){j.insertContent(M,U);}};K.prototype._updateLayout=function(i){};K.prototype._addButtons=function(i,j){var n=this;var A=P._getGridDataConstructor();var M=new g({type:E.Transparent,icon:I.getIconURI("decline"),tooltip:this._oRb.getText("CONDITIONPANEL_REMOVE"+(this._sAddRemoveIconTooltipKey?"_"+this._sAddRemoveIconTooltipKey:"")+"_TOOLTIP"),press:function(){n._handleRemoveCondition(this.oTargetGrid,i);},layoutData:new A({span:"XL1 L1 M1 S1"})});M.oTargetGrid=j;i.addContent(M);i["remove"]=M;var N=new g({text:sap.ui.getCore().getLibraryResourceBundle("sap.ui.comp").getText("VALUEHELPDLG_CONDITIONPANEL_ADD"),tooltip:this._oRb.getText("CONDITIONPANEL_ADD"+(this._sAddRemoveIconTooltipKey?"_"+this._sAddRemoveIconTooltipKey:"")+"_TOOLTIP"),press:function(){n._handleAddCondition(this.oTargetGrid,i,true);},layoutData:new A({span:"XL2 L3 M3 S3",indent:"XL9 L8 M8 S7",linebreak:true})});N.oTargetGrid=j;N.addStyleClass("conditionAddBtnFloatRight");i.addContent(N);i["add"]=N;};K.prototype.getCurrentOparation=function(i){return i.exclude?this._oOperationsHelper.getCorrespondingExcludeOperation(i.operation):i.operation;};K.prototype._hasSecondValue=function(i){return P.prototype._hasSecondValue.apply(this,arguments)||i===H.NotBT;};K.prototype._hasNoValues=function(i){return P.prototype._hasNoValues.apply(this,arguments)||i===H.NotEmpty;};K._getGridConstructor=function(){if(G===undefined){G=sap.ui.requireSync("sap/ui/layout/Grid");}return G;};K._getGridDataConstructor=function(){if(A===undefined){A=sap.ui.requireSync("sap/ui/layout/GridData");}return A;};K.prototype._createConditionsFields=function(){return[{"ID":"select","Label":"","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"CheckBox","Value":""},{"ID":"keyFieldLabel","Text":"Sort By","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"Label"},{"ID":"keyField","Label":"","SpanFilter":"L3 M5 S10","SpanSort":"L5 M5 S12","SpanGroup":"L4 M4 S12","Control":"ComboBox"},{"ID":"operationLabel","Text":"Sort Order","SpanFilter":"L1 M1 S1","SpanSort":"L1 M1 S1","SpanGroup":"L1 M1 S1","Control":"Label"},{"ID":"operation","Label":"","SpanFilter":this._aKeyFields.length>1?"L2 M5 S10":"XL3 L3 M3 S10","SpanSort":D.system.phone?"L5 M5 S8":"L5 M5 S9","SpanGroup":"L2 M5 S10","Control":"ComboBox"},{"ID":"value1","Label":this._sFromLabelText,"SpanFilter":this._aKeyFields.length>1?"L3 M10 S10":"XL4 L4 M4 S10","SpanSort":"L3 M10 S10","SpanGroup":"L3 M10 S10","Control":"TextField","Value":""},{"ID":"value2","Label":this._sToLabelText,"SpanFilter":this._aKeyFields.length>1?"L2 M10 S10":"XL4 L4 M4 S10","SpanSort":"L2 M10 S10","SpanGroup":"L2 M10 S10","Control":"TextField","Value":""},{"ID":"showIfGrouped","Label":this._sShowIfGroupedLabelText,"SpanFilter":"L1 M10 S10","SpanSort":"L1 M10 S10","SpanGroup":"L3 M4 S9","Control":"CheckBox","Value":"false"}];};K.prototype._getSecondValueNegativeIndex=function(){return 2;};K.prototype.fireDataChange=function(i){var j,n=i.newData;if(n){j=n.operation;n.operation=this._oOperationsHelper.isExcludeType(j)?this._oOperationsHelper.getCorrespondingIncludeOperation(j):j;}return C.prototype.fireEvent.call(this,"dataChange",i);};return K;});
