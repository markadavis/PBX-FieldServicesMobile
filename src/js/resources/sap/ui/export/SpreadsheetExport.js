/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','sap/base/Log','sap/ui/Device'],function(q,L,D){'use strict';var a='sap/ui/export/provider/DataProviderBase',b='sap/ui/export/js/XLSXBuilder',c='sap/ui/export/js/libs/JSZip3';function d(p,C){function f(m){return C&&C(m);}function o(P,F,t){f({progress:P,fetched:F||0,total:t||0});}function g(e){f({error:e.message||e});}function h(A){f({finish:true,data:A});}function i(){var S;var e;var t;function m(x,X){e=x.getDataConverter(p);S=new X(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel,p.customizing);o(0,0,(p.dataSource.data||[]).length);t=window.setTimeout(r,0);}function r(){if(S){var x=p.dataSource.data||[];var y=x.length;var R=e(x.slice());S.append(R);o(100,y,y);t=window.setTimeout(u,0);}}function u(){if(S){S.build().then(v);}}function v(x){h(x);S=null;}function w(){window.clearTimeout(t);v();}sap.ui.require([a,b,c],m);return{cancel:w};}function n(u){if(!u){return u;}try{return new URL(u,document.baseURI).toString();}catch(e){return window.URI(u).absoluteTo(document.baseURI).toString();}}function j(){var S,r;function e(v,X){var w=new v(p);S=new X(p.workbook.columns,p.workbook.context,p.workbook.hierarchyLevel,p.customizing);r=w.requestData(m);o(0,0,p.dataSource.count);}function m(M){if(M.rows){S.append(M.rows);}if(M.progress){o(M.progress,M.fetched,M.total);}if(M.error||typeof M.error==='string'){S=null;return g(M.error);}return M.finished&&S.build().then(t);}function t(v){h(v);S=null;}function u(){r.cancel();h();S=null;}sap.ui.require([a,b,c],e);return{cancel:u};}function k(){var m;var r=q.extend(true,{},p);var w=typeof r.worker==='object'?r.worker:{};var t=function(){m.postMessage({cancel:true});h();};function u(A){var B=new Worker(A);B.onmessage=function(e){if(e.data.progress){o(e.data.progress,e.data.fetched,e.data.total);}else if(e.data.error||typeof e.data.error==='string'){g(e.data.error);}else{h(e.data);}};if(navigator.userAgent.indexOf("Firefox")===-1||v(A)){B.onerror=g;}B.postMessage(r);return B;}function v(e){return e.indexOf(window.location.host)>0||/^[^/]+\/[^/].*$|^\/[^/].*$/i.test(e);}function x(){L.warning('Direct worker is not allowed. Load the worker via blob.');var e=window.URI(w.base).absoluteTo("").search("").hash("").toString();w.src=e+w.ref;var A='self.origin = "'+e+'"; '+'importScripts("'+w.src+'")';var B=new Blob([A]);var E=window.URL.createObjectURL(B);return u(E);}function y(){L.warning('Blob worker is not allowed. Use in-process export.');t=j(r).cancel;}function z(){try{m=u(w.src);m.addEventListener('error',function(e){m=x();m.addEventListener('error',function(e){y();e.preventDefault();});e.preventDefault();});}catch(A){try{m=x();}catch(B){y();}}}r.dataSource.dataUrl=n(r.dataSource.dataUrl);r.dataSource.serviceUrl=n(r.dataSource.serviceUrl);w.base=w.base||sap.ui.require.toUrl('sap/ui/export/js/','');w.ref=w.ref||'SpreadsheetWorker.js';w.src=w.base+w.ref;z();return{cancel:function(){t();}};}var l=sap.ui.getCore().getConfiguration().getFormatSettings().getCustomCurrencies();if(l){var s;p.customizing=p.customizing||{};p.customizing.currency={};for(s in l){p.customizing.currency[s]={scale:l[s].digits};}}if(p.dataSource.type==='array'){return i();}else if(p.worker===false||sap.ui.disableExportWorkers===true||(D.browser.msie&&p.dataSource.dataUrl.indexOf('.')===0)){return j();}else{return k();}}return{execute:d};},true);
