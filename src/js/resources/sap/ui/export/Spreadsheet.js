/*!
 * SAPUI5

		(c) Copyright 2009-2020 SAP SE. All rights reserved
	
 */
sap.ui.define(['jquery.sap.global','./library','sap/ui/core/Core','./ExportDialog','sap/ui/base/EventProvider','sap/ui/Device','sap/ui/export/SpreadsheetExport','sap/base/Log','sap/ui/export/ExportUtils'],function(q,l,C,E,a,D,S,L,b){'use strict';var c='sap.ui.export.Spreadsheet';var d=a.extend(c,{constructor:function(s){a.call(this,s);this._mSettings={fileName:'Export',showProgress:true,worker:true};['count','dataSource','fileName','fileType','showProgress','workbook','worker'].forEach(function(p){if(typeof s[p]!=='undefined'){this._mSettings[p]=p!=='dataSource'?s[p]:this.processDataSource(s[p]);}}.bind(this));}});d.prototype.attachBeforeExport=function(o,h,f){return this.attachEvent('beforeExport',o,h,f);};d.prototype.detachBeforeExport=function(h,o){return this.detachEvent('beforeExport',h,o);};d.prototype.attachBeforeSave=function(o,h,f){return this.attachEvent('beforeSave',o,h,f);};d.prototype.detachBeforeSave=function(h,o){return this.detachEvent('beforeSave',h,o);};d.prototype.destroy=function(){a.prototype.destroy.apply(this,arguments);this.cancel();this.bIsDestroyed=true;};d.prototype.cancel=function(){if(this.process){this.process.cancel();this.process=null;}return this;};d.prototype.onprogress=function(p){L.debug('Spreadsheet export: '+p+'% loaded.');};var g=function(B){var i;if(typeof B.getTotalSize==='function'){i=B.getTotalSize();}else if(!B.isA('sap.ui.model.TreeBinding')&&typeof B.isLengthFinal==='function'&&B.isLengthFinal()){i=B.getLength();}if(typeof i!=='number'||i<0||isNaN(i)){i=null;}return i;};var e=function(B){var o=[];if(B.isA('sap.ui.model.ClientListBinding')){var f=B.getModel().getProperty(B.getPath());o={data:(f instanceof Array)?f:[],type:'array'};}if(B.isA('sap.ui.model.ClientTreeBinding')){L.error('Unable to create dataSource configuration due to not supported Binding: '+B.getMetadata().getName());}if(typeof B.getDownloadUrl==='function'){var m=B.getModel(),s=B.getDownloadUrl('json'),h=m.sServiceUrl,v=m.isA('sap.ui.model.odata.v4.ODataModel');s=b.interceptUrl(s);h=b.interceptUrl(h);o={type:'odata',dataUrl:s,serviceUrl:h,headers:v?m.getHttpHeaders():m.getHeaders(),count:g(B),useBatch:v||m.bUseBatch};}return o;};d.prototype.processDataSource=function(o){var m=null;var s=typeof o;if(!o){return;}if(s=='string'){return{count:this._mSettings.count,dataUrl:o,type:'odata',useBatch:false};}if(s!='object'){L.error('Spreadsheet#setDataSource: Unable to apply data source of type '+s);return;}if(o instanceof Array){m={data:o,type:'array'};}if(o.dataUrl){m=o;}if(o.isA&&o.isA(['sap.ui.model.ListBinding','sap.ui.model.TreeBinding'])){m=e(o);}return m;};function _(s,p){return new Promise(function(r,R){var f;var h=D.system.desktop?2000000:100000;var n=p.dataSource.type=='array'?p.dataSource.data.length:p.dataSource.count;var i=p.workbook.columns.length;function o(m){if(!isNaN(m.progress)){if(f){f.updateStatus(m.progress,m.fetched,m.total);}s.onprogress(m.progress);}if(m.finish){s.process=null;if(!m.data){R('Spreadsheet export: The process was canceled');return;}var k=s.fireEvent('beforeSave',{data:m.data},true,true);if(f){window.setTimeout(f.finish,1000);}if(k){b.saveAsFile(new Blob([m.data],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'}),p.fileName);}r();}if(typeof m.error!='undefined'){s.process=null;if(f){f.finish();}R(m.error);E.showErrorMessage(m.error);}}function j(){if(!p.showProgress){if(s.process){R('Cannot start export: the process is already running');return;}s.process=S.execute(p,o);return;}E.getProgressDialog().then(function(k){f=k;if(s.process){R('Cannot start export: the process is already running');return;}f.oncancel=function(){return s.process&&s.process.cancel();};f.open();s.process=S.execute(p,o);});}if(i<=0){R('No columns to export.');}else if(n*i>h||!n){E.showWarningDialog({rows:n,columns:i}).then(j).catch(function(){R('Export cancelled by the user.');});}else{j();}});}d.prototype.build=function(){var p=this._mSettings;if(this.bIsDestroyed){var m=c+': Cannot trigger build - the object has been destroyed';L.error(m);return Promise.reject(m);}return this._setDefaultExportSettings(p).then(function(){this.fireEvent('beforeExport',{exportSettings:p},false,false);b.validateSettings(p);return _(this,p);}.bind(this));};d.prototype._setDefaultExportSettings=function(p){return new Promise(function(r){var R=C.getLibraryResourceBundle('sap.ui.export',true);R.then(function(o){if(typeof p.workbook.context!=='object'){p.workbook.context={};}if(!p.workbook.context.title){p.workbook.context.title=o.getText('XLSX_DEFAULT_TITLE');}if(!p.workbook.context.sheetName){p.workbook.context.sheetName=o.getText('XLSX_DEFAULT_SHEETNAME');}r();});});};return d;});
