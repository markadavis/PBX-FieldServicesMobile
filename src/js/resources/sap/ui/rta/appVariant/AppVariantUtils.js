/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/Utils","sap/m/MessageBox","sap/ui/rta/Utils","sap/ui/core/BusyIndicator","sap/base/util/uid","sap/base/Log","sap/ui/fl/write/api/PersistenceWriteAPI","sap/ui/fl/write/api/AppVariantWriteAPI","sap/ui/fl/write/api/ChangesWriteAPI","sap/ui/fl/write/_internal/connectors/LrepConnector"],function(F,M,R,B,u,L,P,A,C,a){"use strict";var b={};var H=56;b._newAppVariantId=null;b.getManifirstSupport=function(r){return a.appVariant.getManifirstSupport({appId:r});};b.getNewAppVariantId=function(){return b._newAppVariantId;};b.setNewAppVariantId=function(n){b._newAppVariantId=n;};b.trimIdIfRequired=function(i){if(i.length>H){var I=i.split('.');var t;var g=I[I.length-1].length;var G=I.pop();t=I.join(".");if(t.length>g){t=t.substring(0,t.length-g);}else{return i.substr(0,H);}if(t[t.length-1]==='.'){t=t+G;}else{t=t+"."+G;}return this.trimIdIfRequired(t);}return i;};b.getId=function(s){var c;var i=s.split('.');if(i[0]!=="customer"){i[0]="customer."+i[0];}var r=false;var d=/^id.*/i;i.forEach(function(S,e,f){if(S.match(d)){S=S.replace(d,u().replace(/-/g,"_"));f[e]=S;r=true;}});c=i.join(".");if(!r){c=c+"."+u().replace(/-/g,"_");}c=this.trimIdIfRequired(c);this.setNewAppVariantId(c);return c;};b.createAppVariant=function(s,p){p.version="1.0.0";return A.saveAs(Object.assign({selector:s},p));};b.getInlineChangeInput=function(v,c){return{type:"XTIT",maxLength:50,comment:c,value:{"":v}};};b.prepareTextsChange=function(p,s){var c="New "+p+" entered by a key user via RTA tool";return this.getInlineChangeInput(s,c);};b.getInlineChangeInputIcon=function(i){return{content:{icon:i}};};b.prepareRemoveAllInboundsExceptOneChange=function(i){return{content:{inboundId:i}};};b.getInboundInfo=function(i){var I={};if(!i){I.currentRunningInbound="customer.savedAsAppVariant";I.addNewInboundRequired=true;return I;}var p=F.getParsedURLHash();var c=Object.keys(i);var d=[];if(c.length===1&&c[0]==="customer.savedAsAppVariant"){return{currentRunningInbound:"customer.savedAsAppVariant",addNewInboundRequired:false};}c.forEach(function(s){if((i[s].action===p.action)&&(i[s].semanticObject===p.semanticObject)){d.push(s);}});switch(d.length){case 0:I.currentRunningInbound="customer.savedAsAppVariant";I.addNewInboundRequired=true;break;case 1:I.currentRunningInbound=d[0];I.addNewInboundRequired=false;break;default:I.currentRunningInbound="customer.savedAsAppVariant";I.addNewInboundRequired=true;break;}return I;};b.getInboundPropertiesKey=function(s,c,p){return s+"_sap.app.crossNavigation.inbounds."+c+"."+p;};b.getInlineChangeForInboundPropertySaveAs=function(c,s){return{inboundId:c,entityPropertyChange:{propertyPath:"signature/parameters/sap-appvar-id",operation:"UPSERT",propertyValue:{required:true,filter:{value:s,format:"plain"},launcherValue:{value:s}}}};};b.prepareAddNewInboundChange=function(c,s,o){var p=F.getParsedURLHash();var d={content:{inbound:{}},texts:{}};var i=this.getInboundPropertiesKey(o.referenceAppId,c,"title");var I=this.getInboundPropertiesKey(o.referenceAppId,c,"subTitle");d.content.inbound[c]={semanticObject:p.semanticObject,action:p.action,title:"{{"+i+"}}",subTitle:"{{"+I+"}}",icon:o.icon,signature:{parameters:{"sap-appvar-id":{required:true,filter:{value:s,format:"plain"},launcherValue:{value:s}}},additionalParameters:"ignored"}};d.texts[i]=this.prepareTextsChange("title",o.title);d.texts[I]=this.prepareTextsChange("subTitle",o.subTitle);return d;};b.prepareChangeInboundChange=function(c,s,o){var p={content:{},texts:{}};var i=this.getInboundPropertiesKey(o.referenceAppId,c,"title");var I=this.getInboundPropertiesKey(o.referenceAppId,c,"subTitle");p.content={inboundId:c,entityPropertyChange:[{propertyPath:"signature/parameters/sap-appvar-id",operation:"UPSERT",propertyValue:{required:true,filter:{value:s,format:"plain"},launcherValue:{value:s}}},{propertyPath:"title",operation:"UPSERT",propertyValue:"{{"+i+"}}"},{propertyPath:"subTitle",operation:"UPSERT",propertyValue:"{{"+I+"}}"},{propertyPath:"icon",operation:"UPSERT",propertyValue:o.icon}]};p.texts[i]=this.prepareTextsChange("title",o.title);p.texts[I]=this.prepareTextsChange("subTitle",o.subTitle);return p;};b.createInlineChange=function(p,i,s){var c={changeType:i,content:p.content};if(p.texts){c.texts=p.texts;}return C.create({changeSpecificData:c,selector:s});};b.addChangesToPersistence=function(c,s){c.forEach(function(o){return P.add({change:o,selector:s});});return Promise.resolve();};b.getTransportInput=function(p,n,N,t){return{getPackage:function(){return p;},getNamespace:function(){return n;},getId:function(){return N;},getDefinition:function(){return{fileType:t};}};};b.triggerCatalogAssignment=function(s,l,r){return A.assignCatalogs({selector:{appId:s},action:"assignCatalogs",assignFromAppId:r,layer:l});};b.triggerCatalogUnAssignment=function(s,l){return A.unassignCatalogs({selector:{appId:s},action:"unassignCatalogs",layer:l});};b.isS4HanaCloud=function(s){return s.isAtoEnabled()&&s.isAtoAvailable();};b.copyId=function(i){var t=document.createElement("textarea");t.value=i;document.body.appendChild(t);t.select();document.execCommand('copy');document.body.removeChild(t);return true;};b.getTextResources=function(){return sap.ui.getCore().getLibraryResourceBundle("sap.ui.rta");};b.getText=function(m,t){var T=this.getTextResources();return t?T.getText(m,t):T.getText(m);};b._getErrorMessageText=function(e){var E;if(e.messages&&e.messages.length){E=e.messages.map(function(e){return e.text;}).join("\n");}else if(e.iamAppId){E="IAM App Id: "+e.iamAppId;}else{E=e.stack||e.message||e.status||e;}return E;};b.buildErrorInfo=function(m,e,s){var E=this._getErrorMessageText(e);var c=b.getText(m)+"\n\n";if(s){c+=b.getText("MSG_APP_VARIANT_ID",s)+"\n";}c+=b.getText("MSG_TECHNICAL_ERROR",E);L.error("App variant error: ",E);return{text:c,appVariantId:s,error:true};};b.buildSuccessInfo=function(s,S,i){var c=i?"CLOUD":"ON_PREMISE";var o=S?"":"_OVERVIEW_LIST";var t=i?undefined:s;var m=b.getText("SAVE_APP_VARIANT_SUCCESS_MESSAGE")+"\n\n";m+=b.getText("SAVE_APP_VARIANT_SUCCESS_S4HANA_"+c+"_MESSAGE"+o,t);return{text:m,appVariantId:s,copyId:!i};};b.buildFinalSuccessInfoS4HANACloud=function(){var m=b.getText("MSG_SAVE_APP_VARIANT_NEW_TILE_AVAILABLE");return{text:m};};b.buildDeleteSuccessMessage=function(s,i){var m=i?"DELETE_APP_VARIANT_SUCCESS_MESSAGE_CLOUD":"DELETE_APP_VARIANT_SUCCESS_MESSAGE";var c=b.getText(m,s);return{text:c};};b.showRelevantDialog=function(i,s){B.hide();var t;var r;var o;var c;var d=[];if(s){t=this.getText("SAVE_APP_VARIANT_SUCCESS_MESSAGE_TITLE");r=this.getText("SAVE_APP_VARIANT_OK_TEXT");}else{t=this.getText("HEADER_SAVE_APP_VARIANT_FAILED");r=this.getText("SAVE_APP_VARIANT_CLOSE_TEXT");}if(i&&i.copyId){c=this.getText("SAVE_APP_VARIANT_COPY_ID_TEXT");d.push(c);}else if(i&&i.deleteAppVariant){t=this.getText("DELETE_APP_VARIANT_INFO_MESSAGE_TITLE");o=this.getText("DELETE_APP_VARIANT_OK_TEXT");d.push(o);r=this.getText("DELETE_APP_VARIANT_CLOSE_TEXT");}d.push(r);return new Promise(function(e,f){var g=function(h){if(h===c){b.copyId(i.appVariantId);}if(s){e();}else if(i.overviewDialog){e(false);}else if(i.deleteAppVariant&&h===o){e();}else if(i.deleteAppVariant&&h===r){f(i.deleteAppVariant);}else if(i.error){f(i.error);}else{e();}};M.show(i.text,{icon:(s||i.deleteAppVariant)?M.Icon.INFORMATION:M.Icon.ERROR,onClose:g,title:t,actions:d,styleClass:R.getRtaStyleClassName()});});};b.closeOverviewDialog=function(){sap.ui.getCore().getEventBus().publish("sap.ui.rta.appVariant.manageApps.controller.ManageApps","navigate");};b.navigateToFLPHomepage=function(){var o=sap.ushell.services.AppConfiguration.getCurrentApplication();var c=o.componentHandle.getInstance();if(c){F.ifUShellContainerThen(function(s){var d=s[0];if(d&&d.toExternal){d.toExternal({target:{shellHash:"#"}},c);}},["CrossApplicationNavigation"]);}return Promise.resolve();};b.deleteAppVariant=function(s,l){B.hide();return A.deleteAppVariant({selector:s,layer:l});};b.handleBeforeUnloadEvent=function(){var m=b.getText("MSG_DO_NOT_CLOSE_BROWSER");return m;};b.showMessage=function(m){var s=b.getText(m);var i={text:s,copyId:false};return b.showRelevantDialog(i,true);};b.catchErrorDialog=function(e,m,i){B.hide();var E=b.buildErrorInfo(m,e,i);return b.showRelevantDialog(E,false);};return b;},true);
